<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IllustAuto - „É≠„Ç∞„Ç§„É≥</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      color: #333;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .auth-container {
      max-width: 450px;
      width: 100%;
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      padding: 40px;
      text-align: center;
    }
    
    .logo {
      font-size: 48px;
      margin-bottom: 10px;
    }
    
    h1 {
      color: #667eea;
      margin-bottom: 10px;
      font-size: 32px;
    }
    
    .subtitle {
      color: #666;
      margin-bottom: 30px;
      font-size: 14px;
    }
    
    .input-group {
      margin-bottom: 20px;
      text-align: left;
    }
    
    label {
      display: block;
      margin-bottom: 8px;
      color: #555;
      font-weight: 500;
    }
    
    input[type="email"], input[type="text"] {
      width: 100%;
      padding: 15px;
      border: 2px solid #e1e5e9;
      border-radius: 10px;
      font-size: 16px;
      transition: border-color 0.3s;
    }
    
    input[type="email"]:focus, input[type="text"]:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .btn {
      width: 100%;
      padding: 15px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s;
      margin-top: 10px;
    }
    
    .btn:hover {
      transform: translateY(-2px);
    }
    
    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }
    
    .message {
      margin-top: 15px;
      padding: 10px;
      border-radius: 8px;
      font-size: 14px;
    }
    
    .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    .info { background: #cce7ff; color: #004085; border: 1px solid #b3d7ff; }
    
    .hidden { display: none; }
    
    .phase-indicator {
      display: flex;
      justify-content: center;
      margin-bottom: 30px;
    }
    
    .phase {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #e1e5e9;
      margin: 0 8px;
      position: relative;
    }
    
    .phase.active {
      background: #667eea;
    }
    
    .phase.completed {
      background: #28a745;
    }
    
    .phase::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 20px;
      width: 16px;
      height: 2px;
      background: #e1e5e9;
      transform: translateY(-50%);
    }
    
    .phase:last-child::after {
      display: none;
    }
    
    .phase.completed::after {
      background: #28a745;
    }
  </style>
</head>
<body>
  <div class="auth-container">
    <div class="logo">üé®</div>
    <h1>IllustAuto</h1>
    <p class="subtitle">AIÁîªÂÉèÁîüÊàê„Çµ„Éº„Éì„Çπ</p>
    
    <div class="phase-indicator">
      <div class="phase active" id="phase1"></div>
      <div class="phase" id="phase2"></div>
    </div>
    
    <!-- Step 1: Email Input -->
    <div id="step1">
      <div class="input-group">
        <label for="email">„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ</label>
        <input type="email" id="email" placeholder="your@email.com" required>
      </div>
      <button class="btn" onclick="requestAuthCode()">Ë™çË®º„Ç≥„Éº„Éâ„ÇíÈÄÅ‰ø°</button>
    </div>
    
    <!-- Step 2: Code Verification -->
    <div id="step2" class="hidden">
      <div class="input-group">
        <label for="authCode">Ë™çË®º„Ç≥„Éº„Éâ</label>
        <input type="text" id="authCode" placeholder="6Ê°Å„ÅÆË™çË®º„Ç≥„Éº„Éâ" maxlength="6" required>
      </div>
      <button class="btn" onclick="verifyCode()" id="loginBtn">„É≠„Ç∞„Ç§„É≥</button>
      <button class="btn" style="background: #6c757d; margin-top: 10px;" onclick="goBackToEmail()">Êàª„Çã</button>
    </div>
    
    <!-- Step 3: ÂâäÈô§ÔºàÂç≥Â∫ß„Å´„É™„ÉÄ„Ç§„É¨„ÇØ„Éà„Åô„Çã„Åü„ÇÅ‰∏çË¶ÅÔºâ -->
    
    <div id="message"></div>
  </div>

  <script>
    const BACKEND = 'https://illustauto-backend-production.up.railway.app';
    let currentStep = 1;

    function showMessage(text, type = 'info') {
      const messageDiv = document.getElementById('message');
      messageDiv.className = `message ${type}`;
      messageDiv.textContent = text;
      messageDiv.style.display = 'block';
      
      if (type === 'success') {
        setTimeout(() => messageDiv.style.display = 'none', 5000);
      }
    }

    function updatePhase(step) {
      for (let i = 1; i <= 2; i++) {
        const phase = document.getElementById(`phase${i}`);
        const stepDiv = document.getElementById(`step${i}`);
        
        if (i < step) {
          phase.className = 'phase completed';
          stepDiv.className = 'hidden';
        } else if (i === step) {
          phase.className = 'phase active';
          stepDiv.className = '';
        } else {
          phase.className = 'phase';
          stepDiv.className = 'hidden';
        }
      }
      currentStep = step;
    }

    function goBackToEmail() {
      updatePhase(1);
      document.getElementById('message').style.display = 'none';
    }

    async function requestAuthCode() {
      const email = document.getElementById('email').value.trim();
      
      if (!email) {
        showMessage('„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
        return;
      }

      if (!email.includes('@')) {
        showMessage('ÊúâÂäπ„Å™„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
        return;
      }

      try {
        const xhr = new XMLHttpRequest();
        xhr.open('POST', `${BACKEND}/api/auth/request-code`, true);
        xhr.setRequestHeader('Content-Type', 'application/json');
        
        xhr.onload = function() {
          if (xhr.status === 200) {
            const data = JSON.parse(xhr.responseText);
            if (data.success) {
              showMessage('Ë™çË®º„Ç≥„Éº„Éâ„ÇíÈÄÅ‰ø°„Åó„Åæ„Åó„Åü„ÄÇ„É°„Éº„É´„Çí„ÅîÁ¢∫Ë™ç„Åè„Å†„Åï„ÅÑ„ÄÇ', 'success');
              updatePhase(2);
            } else {
              showMessage(data.message || 'Ë™çË®º„Ç≥„Éº„Éâ„ÅÆÈÄÅ‰ø°„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
            }
          } else {
            const errorData = JSON.parse(xhr.responseText);
            showMessage(errorData.message || '„Çµ„Éº„Éê„Éº„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü', 'error');
          }
        };
        
        xhr.onerror = function() {
          showMessage('„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü', 'error');
        };
        
        xhr.send(JSON.stringify({ email: email }));
        
      } catch (error) {
        console.error('Request error:', error);
        showMessage('„É™„ÇØ„Ç®„Çπ„Éà„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü', 'error');
      }
    }

    let isVerifying = false;
    let pendingRequest = null;
    
    async function verifyCode() {
      // „Éú„Çø„É≥„ÇíÂç≥Â∫ß„Å´ÁÑ°ÂäπÂåñ
      const loginBtn = document.getElementById('loginBtn');
      if (loginBtn.disabled) {
        console.log('„Éú„Çø„É≥„ÅåÁÑ°ÂäπÂåñÊ∏à„Åø - Âá¶ÁêÜ‰∏≠Ê≠¢');
        return;
      }
      loginBtn.disabled = true;
      loginBtn.textContent = 'Âá¶ÁêÜ‰∏≠...';
      
      if (isVerifying || pendingRequest) {
        console.log('Êó¢„Å´Ê§úË®ºÂá¶ÁêÜ‰∏≠„Åß„Åô - „É™„ÇØ„Ç®„Çπ„Éà‰∏≠Ê≠¢');
        return;
      }
      
      isVerifying = true;
      const email = document.getElementById('email').value.trim();
      const authCode = document.getElementById('authCode').value.trim();
      
      console.log('Ë™çË®ºÈñãÂßã:', { email: email, code: authCode });
      
      if (!authCode) {
        showMessage('Ë™çË®º„Ç≥„Éº„Éâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
        loginBtn.disabled = false;
        loginBtn.textContent = '„É≠„Ç∞„Ç§„É≥';
        isVerifying = false;
        return;
      }

      if (authCode.length !== 6) {
        showMessage('Ë™çË®º„Ç≥„Éº„Éâ„ÅØ6Ê°Å„Åß„Åô', 'error');
        loginBtn.disabled = false;
        loginBtn.textContent = '„É≠„Ç∞„Ç§„É≥';
        isVerifying = false;
        return;
      }

      try {
        const xhr = new XMLHttpRequest();
        pendingRequest = xhr;
        xhr.open('POST', `${BACKEND}/api/auth/verify-code`, true);
        xhr.setRequestHeader('Content-Type', 'application/json');
        
        xhr.onload = function() {
          pendingRequest = null;
          console.log('üîç Ë™çË®º„É¨„Çπ„Éù„É≥„ÇπË©≥Á¥∞ÊÉÖÂ†±:');
          console.log('- HTTP„Çπ„ÉÜ„Éº„Çø„Çπ:', xhr.status);
          console.log('- „É¨„Çπ„Éù„É≥„Çπ„ÉÜ„Ç≠„Çπ„Éà:', xhr.responseText);
          console.log('- „É¨„Çπ„Éù„É≥„Çπ„Éò„ÉÉ„ÉÄ„Éº:', xhr.getAllResponseHeaders());
          
          if (xhr.status === 200) {
            const data = JSON.parse(xhr.responseText);
            console.log('„Éë„Éº„ÇπÂæå„Éá„Éº„Çø:', data);
            
            if (data.success && data.tokens) {
              // ÈáçË§áÈÄÅ‰ø°„ÇíÈò≤„Åê„Éï„É©„Ç∞„ÅØ„Åù„ÅÆ„Åæ„ÅæÔºàÊó¢„Å´trueÔºâ
              
              // „Éà„Éº„ÇØ„É≥„Çí‰øùÂ≠ò
              localStorage.setItem('access_token', data.tokens.accessToken);
              localStorage.setItem('refresh_token', data.tokens.refreshToken);
              
              console.log('‚úÖ Ë™çË®ºÊàêÂäüÔºÅÂç≥Â∫ß„Å´„É™„ÉÄ„Ç§„É¨„ÇØ„Éà');
              
              // ÂÆâÂÖ®„Å´„É™„ÉÄ„Ç§„É¨„ÇØ„Éà
              setTimeout(() => {
                window.location.href = './app.html';
              }, 50);
            } else {
              console.log('‚ùå Ë™çË®ºÂ§±Êïó - data.success or data.tokens „Åå false');
              showMessage(data.message || 'Ë™çË®º„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
              loginBtn.disabled = false;
              loginBtn.textContent = '„É≠„Ç∞„Ç§„É≥';
              isVerifying = false;
            }
          } else {
            console.log('‚ùå HTTP„Ç®„É©„Éº:', xhr.status);
            console.log('‚ùå „Ç®„É©„Éº„É¨„Çπ„Éù„É≥„ÇπÁîü„ÉÜ„Ç≠„Çπ„Éà:', xhr.responseText);
            try {
              const errorData = JSON.parse(xhr.responseText);
              console.log('‚ùå „Éë„Éº„ÇπÊ∏à„Åø„Ç®„É©„Éº:', errorData);
              showMessage(errorData.message || `HTTP ${xhr.status}: Ë™çË®º„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü`, 'error');
            } catch (parseError) {
              console.log('‚ùå JSON„Éë„Éº„Çπ„Ç®„É©„Éº:', parseError);
              showMessage(`HTTP ${xhr.status}: „Çµ„Éº„Éê„Éº„Ç®„É©„Éº`, 'error');
            }
            loginBtn.disabled = false;
            loginBtn.textContent = '„É≠„Ç∞„Ç§„É≥';
            isVerifying = false;
          }
        };
        
        xhr.onerror = function() {
          pendingRequest = null;
          console.log('‚ùå „Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„Ç®„É©„Éº');
          showMessage('„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü', 'error');
          loginBtn.disabled = false;
          loginBtn.textContent = '„É≠„Ç∞„Ç§„É≥';
          isVerifying = false;
        };
        
        xhr.send(JSON.stringify({ 
          email: email, 
          code: authCode 
        }));
        
      } catch (error) {
        pendingRequest = null;
        console.error('Verify error:', error);
        showMessage('Ë™çË®º„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü', 'error');
        loginBtn.disabled = false;
        loginBtn.textContent = '„É≠„Ç∞„Ç§„É≥';
        isVerifying = false;
      }
    }

    // Enter „Ç≠„Éº„Åß„ÅÆÈÄÅ‰ø°
    document.getElementById('email').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') requestAuthCode();
    });

    document.getElementById('authCode').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault(); // „Éá„Éï„Ç©„É´„ÉàÂãï‰Ωú„ÇíÈò≤„Åê
        const loginBtn = document.getElementById('loginBtn');
        if (!loginBtn.disabled && !isVerifying) {
          verifyCode();
        }
      }
    });
  </script>
</body>
</html>

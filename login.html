<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IllustAuto - „É≠„Ç∞„Ç§„É≥</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      color: #333;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .auth-container {
      max-width: 450px;
      width: 100%;
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      padding: 40px;
      text-align: center;
    }
    
    .logo {
      font-size: 48px;
      margin-bottom: 10px;
    }
    
    h1 {
      color: #667eea;
      margin-bottom: 10px;
      font-size: 32px;
    }
    
    .subtitle {
      color: #666;
      margin-bottom: 30px;
      font-size: 14px;
    }
    
    .input-group {
      margin-bottom: 20px;
      text-align: left;
    }
    
    label {
      display: block;
      margin-bottom: 8px;
      color: #555;
      font-weight: 500;
    }
    
    input[type="email"], input[type="text"] {
      width: 100%;
      padding: 15px;
      border: 2px solid #e1e5e9;
      border-radius: 10px;
      font-size: 16px;
      transition: border-color 0.3s;
    }
    
    input[type="email"]:focus, input[type="text"]:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .btn {
      width: 100%;
      padding: 15px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s;
      margin-top: 10px;
    }
    
    .btn:hover {
      transform: translateY(-2px);
    }
    
    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }
    
    .message {
      margin-top: 15px;
      padding: 10px;
      border-radius: 8px;
      font-size: 14px;
    }
    
    .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    .info { background: #cce7ff; color: #004085; border: 1px solid #b3d7ff; }
    
    .hidden { display: none; }
    
    .phase-indicator {
      display: flex;
      justify-content: center;
      margin-bottom: 30px;
    }
    
    .phase {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #e1e5e9;
      margin: 0 8px;
      position: relative;
    }
    
    .phase.active {
      background: #667eea;
    }
    
    .phase.completed {
      background: #28a745;
    }
    
    .phase::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 20px;
      width: 16px;
      height: 2px;
      background: #e1e5e9;
      transform: translateY(-50%);
    }
    
    .phase:last-child::after {
      display: none;
    }
    
    .phase.completed::after {
      background: #28a745;
    }
  </style>
</head>
<body>
  <div class="auth-container">
    <div class="logo">üé®</div>
    <h1>IllustAuto</h1>
    <p class="subtitle">AIÁîªÂÉèÁîüÊàê„Çµ„Éº„Éì„Çπ</p>
    
    <div class="phase-indicator">
      <div class="phase active" id="phase1"></div>
      <div class="phase" id="phase2"></div>
      <div class="phase" id="phase3"></div>
    </div>
    
    <!-- Step 1: Email Input -->
    <div id="step1">
      <div class="input-group">
        <label for="email">„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ</label>
        <input type="email" id="email" placeholder="your@email.com" required>
      </div>
      <button class="btn" onclick="requestAuthCode()">Ë™çË®º„Ç≥„Éº„Éâ„ÇíÈÄÅ‰ø°</button>
    </div>
    
    <!-- Step 2: Code Verification -->
    <div id="step2" class="hidden">
      <div class="input-group">
        <label for="authCode">Ë™çË®º„Ç≥„Éº„Éâ</label>
        <input type="text" id="authCode" placeholder="6Ê°Å„ÅÆË™çË®º„Ç≥„Éº„Éâ" maxlength="6" required>
      </div>
      <button class="btn" onclick="verifyCode()">„É≠„Ç∞„Ç§„É≥</button>
      <button class="btn" style="background: #6c757d; margin-top: 10px;" onclick="goBackToEmail()">Êàª„Çã</button>
    </div>
    
    <!-- Step 3: Success -->
    <div id="step3" class="hidden">
      <div class="message success">
        <strong>‚úÖ „É≠„Ç∞„Ç§„É≥ÊàêÂäü!</strong><br>
        „Ç¢„Éó„É™„Éö„Éº„Ç∏„Å´„É™„ÉÄ„Ç§„É¨„ÇØ„Éà„Åó„Å¶„ÅÑ„Åæ„Åô...
      </div>
    </div>
    
    <div id="message"></div>
  </div>

  <script>
    const BACKEND = 'https://illustauto-backend-production.up.railway.app';
    let currentStep = 1;

    function showMessage(text, type = 'info') {
      const messageDiv = document.getElementById('message');
      messageDiv.className = `message ${type}`;
      messageDiv.textContent = text;
      messageDiv.style.display = 'block';
      
      if (type === 'success') {
        setTimeout(() => messageDiv.style.display = 'none', 5000);
      }
    }

    function updatePhase(step) {
      for (let i = 1; i <= 3; i++) {
        const phase = document.getElementById(`phase${i}`);
        const stepDiv = document.getElementById(`step${i}`);
        
        if (i < step) {
          phase.className = 'phase completed';
          stepDiv.className = 'hidden';
        } else if (i === step) {
          phase.className = 'phase active';
          stepDiv.className = '';
        } else {
          phase.className = 'phase';
          stepDiv.className = 'hidden';
        }
      }
      currentStep = step;
    }

    function goBackToEmail() {
      updatePhase(1);
      document.getElementById('message').style.display = 'none';
    }

    async function requestAuthCode() {
      const email = document.getElementById('email').value.trim();
      
      if (!email) {
        showMessage('„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
        return;
      }

      if (!email.includes('@')) {
        showMessage('ÊúâÂäπ„Å™„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
        return;
      }

      try {
        const xhr = new XMLHttpRequest();
        xhr.open('POST', `${BACKEND}/api/auth/request-code`, true);
        xhr.setRequestHeader('Content-Type', 'application/json');
        
        xhr.onload = function() {
          if (xhr.status === 200) {
            const data = JSON.parse(xhr.responseText);
            if (data.success) {
              showMessage('Ë™çË®º„Ç≥„Éº„Éâ„ÇíÈÄÅ‰ø°„Åó„Åæ„Åó„Åü„ÄÇ„É°„Éº„É´„Çí„ÅîÁ¢∫Ë™ç„Åè„Å†„Åï„ÅÑ„ÄÇ', 'success');
              updatePhase(2);
            } else {
              showMessage(data.message || 'Ë™çË®º„Ç≥„Éº„Éâ„ÅÆÈÄÅ‰ø°„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
            }
          } else {
            const errorData = JSON.parse(xhr.responseText);
            showMessage(errorData.message || '„Çµ„Éº„Éê„Éº„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü', 'error');
          }
        };
        
        xhr.onerror = function() {
          showMessage('„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü', 'error');
        };
        
        xhr.send(JSON.stringify({ email: email }));
        
      } catch (error) {
        console.error('Request error:', error);
        showMessage('„É™„ÇØ„Ç®„Çπ„Éà„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü', 'error');
      }
    }

    async function verifyCode() {
      const email = document.getElementById('email').value.trim();
      const authCode = document.getElementById('authCode').value.trim();
      
      if (!authCode) {
        showMessage('Ë™çË®º„Ç≥„Éº„Éâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
        return;
      }

      if (authCode.length !== 6) {
        showMessage('Ë™çË®º„Ç≥„Éº„Éâ„ÅØ6Ê°Å„Åß„Åô', 'error');
        return;
      }

      try {
        const xhr = new XMLHttpRequest();
        xhr.open('POST', `${BACKEND}/api/auth/verify-code`, true);
        xhr.setRequestHeader('Content-Type', 'application/json');
        
        xhr.onload = function() {
          if (xhr.status === 200) {
            const data = JSON.parse(xhr.responseText);
            if (data.success && data.tokens) {
              // „Éà„Éº„ÇØ„É≥„Çí‰øùÂ≠ò
              localStorage.setItem('access_token', data.tokens.accessToken);
              localStorage.setItem('refresh_token', data.tokens.refreshToken);
              
              updatePhase(3);
              
              // Âç≥Â∫ß„Å´„É™„ÉÄ„Ç§„É¨„ÇØ„ÉàÂÆüË°å
              console.log('Ë™çË®ºÊàêÂäü - Âç≥Â∫ß„Å´„É™„ÉÄ„Ç§„É¨„ÇØ„ÉàÂÆüË°å');
              console.log('„Éà„Éº„ÇØ„É≥:', data.tokens.accessToken.substring(0, 20) + '...');
              
              // „Éö„Éº„Ç∏„ÇíÂº∑Âà∂ÁöÑ„Å´Â§âÊõ¥
              const targetUrl = '/illustauto/app.html';
              console.log('ÈÅ∑ÁßªÂÖàURL:', targetUrl);
              alert('Ë™çË®ºÊàêÂäüÔºÅapp.html„Å´ÈÅ∑Áßª„Åó„Åæ„Åô„ÄÇOKÊäº„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
              window.location.replace(targetUrl);
            } else {
              showMessage(data.message || 'Ë™çË®º„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
            }
          } else {
            const errorData = JSON.parse(xhr.responseText);
            showMessage(errorData.message || 'Ë™çË®º„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü', 'error');
          }
        };
        
        xhr.onerror = function() {
          showMessage('„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü', 'error');
        };
        
        xhr.send(JSON.stringify({ 
          email: email, 
          code: authCode 
        }));
        
      } catch (error) {
        console.error('Verify error:', error);
        showMessage('Ë™çË®º„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü', 'error');
      }
    }

    // Enter „Ç≠„Éº„Åß„ÅÆÈÄÅ‰ø°
    document.getElementById('email').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') requestAuthCode();
    });

    document.getElementById('authCode').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') verifyCode();
    });
  </script>
</body>
</html>

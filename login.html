<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IllustAuto - ãƒ­ã‚°ã‚¤ãƒ³</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      color: #333;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .auth-container {
      max-width: 450px;
      width: 100%;
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      padding: 40px;
      text-align: center;
    }
    
    .logo {
      font-size: 48px;
      margin-bottom: 10px;
    }
    
    h1 {
      color: #667eea;
      margin-bottom: 10px;
      font-size: 32px;
    }
    
    .subtitle {
      color: #666;
      margin-bottom: 30px;
      font-size: 14px;
    }
    
    .input-group {
      margin-bottom: 20px;
      text-align: left;
    }
    
    label {
      display: block;
      margin-bottom: 8px;
      color: #555;
      font-weight: 500;
    }
    
    input[type="email"], input[type="text"] {
      width: 100%;
      padding: 15px;
      border: 2px solid #e1e5e9;
      border-radius: 10px;
      font-size: 16px;
      transition: border-color 0.3s;
    }
    
    input[type="email"]:focus, input[type="text"]:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .btn {
      width: 100%;
      padding: 15px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s;
      margin-top: 10px;
    }
    
    .btn:hover {
      transform: translateY(-2px);
    }
    
    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }
    
    .message {
      margin-top: 15px;
      padding: 10px;
      border-radius: 8px;
      font-size: 14px;
    }
    
    .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    .info { background: #cce7ff; color: #004085; border: 1px solid #b3d7ff; }
    
    .hidden { display: none; }
    
    .phase-indicator {
      display: flex;
      justify-content: center;
      margin-bottom: 30px;
    }
    
    .phase {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #e1e5e9;
      margin: 0 8px;
      position: relative;
    }
    
    .phase.active {
      background: #667eea;
    }
    
    .phase.completed {
      background: #28a745;
    }
    
    .phase::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 20px;
      width: 16px;
      height: 2px;
      background: #e1e5e9;
      transform: translateY(-50%);
    }
    
    .phase:last-child::after {
      display: none;
    }
    
    .phase.completed::after {
      background: #28a745;
    }
  </style>
</head>
<body>
  <div class="auth-container">
    <div class="logo">ğŸ¨</div>
    <h1>IllustAuto</h1>
    <p class="subtitle">AIç”»åƒç”Ÿæˆã‚µãƒ¼ãƒ“ã‚¹</p>
    
    <div class="phase-indicator">
      <div class="phase active" id="phase1"></div>
      <div class="phase" id="phase2"></div>
    </div>
    
    <!-- Step 1: Email Input -->
    <div id="step1">
      <div class="input-group">
        <label for="email">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
        <input type="email" id="email" placeholder="your@email.com" required>
      </div>
      <button class="btn" onclick="requestAuthCode()">èªè¨¼ã‚³ãƒ¼ãƒ‰ã‚’é€ä¿¡</button>
    </div>
    
    <!-- Step 2: Code Verification -->
    <div id="step2" class="hidden">
      <div class="input-group">
        <label for="authCode">èªè¨¼ã‚³ãƒ¼ãƒ‰</label>
        <input type="text" id="authCode" placeholder="6æ¡ã®èªè¨¼ã‚³ãƒ¼ãƒ‰" maxlength="6" required>
      </div>
      <button class="btn" onclick="verifyCode()" id="loginBtn">ãƒ­ã‚°ã‚¤ãƒ³</button>
      <button class="btn" style="background: #6c757d; margin-top: 10px;" onclick="goBackToEmail()">æˆ»ã‚‹</button>
    </div>
    
    <!-- Step 3: å‰Šé™¤ï¼ˆå³åº§ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã™ã‚‹ãŸã‚ä¸è¦ï¼‰ -->
    
    <div id="message"></div>
  </div>

  <script>
    const BACKEND = 'https://illustauto-backend-production.up.railway.app';
    let currentStep = 1;

    function showMessage(text, type = 'info') {
      const messageDiv = document.getElementById('message');
      messageDiv.className = `message ${type}`;
      messageDiv.textContent = text;
      messageDiv.style.display = 'block';
      
      if (type === 'success') {
        setTimeout(() => messageDiv.style.display = 'none', 5000);
      }
    }

    function updatePhase(step) {
      for (let i = 1; i <= 2; i++) {
        const phase = document.getElementById(`phase${i}`);
        const stepDiv = document.getElementById(`step${i}`);
        
        if (i < step) {
          phase.className = 'phase completed';
          stepDiv.className = 'hidden';
        } else if (i === step) {
          phase.className = 'phase active';
          stepDiv.className = '';
        } else {
          phase.className = 'phase';
          stepDiv.className = 'hidden';
        }
      }
      currentStep = step;
    }

    function goBackToEmail() {
      updatePhase(1);
      document.getElementById('message').style.display = 'none';
    }

    async function requestAuthCode() {
      const email = document.getElementById('email').value.trim();
      
      if (!email) {
        showMessage('ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
        return;
      }

      if (!email.includes('@')) {
        showMessage('æœ‰åŠ¹ãªãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
        return;
      }

      try {
        const xhr = new XMLHttpRequest();
        xhr.open('POST', `${BACKEND}/api/auth/request-code`, true);
        xhr.setRequestHeader('Content-Type', 'application/json');
        
        xhr.onload = function() {
          if (xhr.status === 200) {
            const data = JSON.parse(xhr.responseText);
            if (data.success) {
              showMessage('èªè¨¼ã‚³ãƒ¼ãƒ‰ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚ãƒ¡ãƒ¼ãƒ«ã‚’ã”ç¢ºèªãã ã•ã„ã€‚', 'success');
              updatePhase(2);
            } else {
              showMessage(data.message || 'èªè¨¼ã‚³ãƒ¼ãƒ‰ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
          } else {
            const errorData = JSON.parse(xhr.responseText);
            showMessage(errorData.message || 'ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
          }
        };
        
        xhr.onerror = function() {
          showMessage('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
        };
        
        xhr.send(JSON.stringify({ email: email }));
        
      } catch (error) {
        console.error('Request error:', error);
        showMessage('ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
      }
    }

    let isVerifying = false;
    let pendingRequest = null;
    
    async function verifyCode() {
      // ãƒœã‚¿ãƒ³ã‚’å³åº§ã«ç„¡åŠ¹åŒ–
      const loginBtn = document.getElementById('loginBtn');
      if (loginBtn.disabled) {
        console.log('ãƒœã‚¿ãƒ³ãŒç„¡åŠ¹åŒ–æ¸ˆã¿ - å‡¦ç†ä¸­æ­¢');
        return;
      }
      loginBtn.disabled = true;
      loginBtn.textContent = 'å‡¦ç†ä¸­...';
      
      if (isVerifying || pendingRequest) {
        console.log('æ—¢ã«æ¤œè¨¼å‡¦ç†ä¸­ã§ã™ - ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¸­æ­¢');
        return;
      }
      
      isVerifying = true;
      const email = document.getElementById('email').value.trim();
      const authCode = document.getElementById('authCode').value.trim();
      
      console.log('èªè¨¼é–‹å§‹:', { email: email, code: authCode });
      
      if (!authCode) {
        showMessage('èªè¨¼ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
        loginBtn.disabled = false;
        loginBtn.textContent = 'ãƒ­ã‚°ã‚¤ãƒ³';
        isVerifying = false;
        return;
      }

      if (authCode.length !== 6) {
        showMessage('èªè¨¼ã‚³ãƒ¼ãƒ‰ã¯6æ¡ã§ã™', 'error');
        loginBtn.disabled = false;
        loginBtn.textContent = 'ãƒ­ã‚°ã‚¤ãƒ³';
        isVerifying = false;
        return;
      }

      try {
        const xhr = new XMLHttpRequest();
        pendingRequest = xhr;
        xhr.open('POST', `${BACKEND}/api/auth/verify-code`, true);
        xhr.setRequestHeader('Content-Type', 'application/json');
        
        xhr.onload = function() {
          pendingRequest = null;
          console.log('ğŸ” èªè¨¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹è©³ç´°æƒ…å ±:');
          console.log('- HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:', xhr.status);
          console.log('- ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ†ã‚­ã‚¹ãƒˆ:', xhr.responseText);
          console.log('- ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ˜ãƒƒãƒ€ãƒ¼:', xhr.getAllResponseHeaders());
          
          if (xhr.status === 200) {
            const data = JSON.parse(xhr.responseText);
            console.log('ãƒ‘ãƒ¼ã‚¹å¾Œãƒ‡ãƒ¼ã‚¿:', data);
            
            if (data.success && data.tokens) {
              // é‡è¤‡é€ä¿¡ã‚’é˜²ããƒ•ãƒ©ã‚°ã¯ãã®ã¾ã¾ï¼ˆæ—¢ã«trueï¼‰
              
              // ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä¿å­˜
              localStorage.setItem('access_token', data.tokens.accessToken);
              localStorage.setItem('refresh_token', data.tokens.refreshToken);
              
              console.log('âœ… èªè¨¼æˆåŠŸï¼å³åº§ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ');
              
              // å®‰å…¨ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
              setTimeout(() => {
                window.location.href = './app.html';
              }, 50);
            } else {
              console.log('âŒ èªè¨¼å¤±æ•— - data.success or data.tokens ãŒ false');
              showMessage(data.message || 'èªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
              loginBtn.disabled = false;
              loginBtn.textContent = 'ãƒ­ã‚°ã‚¤ãƒ³';
              isVerifying = false;
            }
          } else {
            console.log('âŒ HTTPã‚¨ãƒ©ãƒ¼:', xhr.status);
            console.log('âŒ ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ç”Ÿãƒ†ã‚­ã‚¹ãƒˆ:', xhr.responseText);
            try {
              const errorData = JSON.parse(xhr.responseText);
              console.log('âŒ ãƒ‘ãƒ¼ã‚¹æ¸ˆã¿ã‚¨ãƒ©ãƒ¼:', errorData);
              showMessage(errorData.message || `HTTP ${xhr.status}: èªè¨¼ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ`, 'error');
            } catch (parseError) {
              console.log('âŒ JSONãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼:', parseError);
              showMessage(`HTTP ${xhr.status}: ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼`, 'error');
            }
            loginBtn.disabled = false;
            loginBtn.textContent = 'ãƒ­ã‚°ã‚¤ãƒ³';
            isVerifying = false;
          }
        };
        
        xhr.onerror = function() {
          pendingRequest = null;
          console.log('âŒ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼');
          showMessage('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
          loginBtn.disabled = false;
          loginBtn.textContent = 'ãƒ­ã‚°ã‚¤ãƒ³';
          isVerifying = false;
        };
        
        xhr.send(JSON.stringify({ 
          email: email, 
          code: authCode 
        }));
        
      } catch (error) {
        pendingRequest = null;
        console.error('Verify error:', error);
        showMessage('èªè¨¼ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
        loginBtn.disabled = false;
        loginBtn.textContent = 'ãƒ­ã‚°ã‚¤ãƒ³';
        isVerifying = false;
      }
    }

    // Enter ã‚­ãƒ¼ã§ã®é€ä¿¡
    document.getElementById('email').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') requestAuthCode();
    });

    document.getElementById('authCode').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault(); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå‹•ä½œã‚’é˜²ã
        const loginBtn = document.getElementById('loginBtn');
        if (!loginBtn.disabled && !isVerifying) {
          verifyCode();
        }
      }
    });
  </script>
</body>
</html>

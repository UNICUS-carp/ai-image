
<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Illustauto （画像生成Webアプリ）</title>
    <style>
      :root { color-scheme: light; }
      body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif; margin:0; padding:24px; background:#f8fafc; }
      .wrap { max-width: 980px; margin: 0 auto; background:#fff; border-radius:12px; box-shadow:0 12px 32px rgba(15,23,42,.08); padding:24px; }
      h1 { margin: 0 0 8px; font-size: 22px; }
      p  { margin: 0 0 16px; color:#334155; }
      .row { display:flex; gap:12px; align-items:center; flex-wrap: wrap; margin: 8px 0; }
      label { min-width: 120px; color:#334155; }
      input[type="text"] { width: 320px; padding: 8px 10px; border:1px solid #e2e8f0; border-radius:8px; font:14px system-ui; }
      select { padding: 8px 10px; border:1px solid #e2e8f0; border-radius:8px; font:14px system-ui; background:#fff; cursor:pointer; }
      textarea { width: 100%; min-height: 140px; padding: 10px; border:1px solid #e2e8f0; border-radius:8px; font:14px system-ui; }
      button { appearance:none; border:0; border-radius:10px; padding:10px 14px; background:#0ea5e9; color:#fff; font-weight:600; cursor:pointer; }
      button:disabled { opacity:.5; cursor: default; }
      .status { margin-top: 12px; padding: 12px 14px; border-radius: 8px; background: #eff6ff; color:#1e3a8a; white-space: pre-wrap; font: 14px/1.6 system-ui; }
      .ok { background:#ecfdf5; color:#065f46; }
      .error { background:#fef2f2; color:#991b1b; }
      .imgbox { margin-top: 12px; display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:14px; }
      .card { border:1px solid #e2e8f0; border-radius:12px; padding:10px; background:#fff; display:flex; flex-direction:column; }
      .meta { font-size:12px; color:#64748b; margin:6px 0 8px; white-space:pre-wrap; }
      img.preview { width: 100%; height: auto; border-radius: 8px; display:block; }
      .actions { display:flex; gap:8px; margin-top:10px; }
      .btn-dl { display:inline-block;background:#10b981;color:#fff;padding:8px 12px;border-radius:8px;text-decoration:none;font-weight:600; }
      .btn-re { background:#6366f1; color:#fff; border-radius:8px; padding:8px 12px; font-weight:600; cursor:pointer; border:0; }
      .muted { color:#64748b; font-size:12px; }
      hr { margin:20px 0; border:none; border-top:1px solid #e2e8f0 }
    </style>
  </head>
  <body>
    <div class="wrap">
      <h1>Illustauto</h1>
      <p>本文の長さに応じて自動で画像を1〜5枚を生成します。</p>

      <div class="row">
        <label for="userId">ユーザーID（任意）</label>
        <input id="userId" type="text" value="stage-user" />
        <button id="btnToken">clientToken 取得</button>
      </div>
      <div id="statusToken" class="status">待機中…（「clientToken 取得」を押してください）</div>

      <hr />

      <div class="row">
        <label for="article">本文（ブログ全体を貼り付け）</label>
      </div>
      <textarea id="article">
本文の内容に応じて自動で画像を1〜5枚を生成します。</textarea>

      <div class="row">
        <label for="taste">テイスト</label>
        <select id="taste">
          <option value="photorealistic">写真画質（デフォルト）</option>
          <option value="deformed">デフォルメ</option>
          <option value="handdrawn">手書き風</option>
          <option value="detailed">精密</option>
          <option value="pictogram">ピクトグラム</option>
        </select>
      </div>

      <div class="row">
        <label for="aspectRatio">画像サイズ</label>
        <select id="aspectRatio">
          <option value="1:1">1:1 スクエア（デフォルト）</option>
          <option value="9:16">9:16 縦長</option>
          <option value="16:9">16:9 横長</option>
        </select>
      </div>

      <div class="row">
        <button id="btnGenerate">画像生成</button>
        <span class="muted">※ 完了後「再生成」に変わります。</span>
      </div>
      <div id="statusGen" class="status">待機中…（「画像生成」を押してください）</div>

      <div id="gallery" class="imgbox"></div>

    </div>

    <script>
      const BACKEND = "https://illustauto-backend-production.up.railway.app";

      const $userId = document.getElementById("userId");
      const $btnToken = document.getElementById("btnToken");
      const $statusToken = document.getElementById("statusToken");

      const $article = document.getElementById("article");
      const $taste = document.getElementById("taste");
      const $aspectRatio = document.getElementById("aspectRatio");
      const $btnGenerate = document.getElementById("btnGenerate");
      const $statusGen = document.getElementById("statusGen");
      const $gallery = document.getElementById("gallery");

      let lastClientToken = null;

      // ========================================
      // バリアント定義（30種類の構図パターン）
      // ========================================
      const VISUAL_VARIANTS = [
        {
          angle: "正面から見上げるローアングル",
          shot: "全身を捉えた広角ショット",
          lighting: "逆光でシルエットを強調",
          mood: "力強さと決意を感じる雰囲気",
          environment: "都市の高層ビル群を背景に"
        },
        {
          angle: "斜め45度の視点",
          shot: "バストアップで表情に焦点",
          lighting: "柔らかい自然光が顔に当たる",
          mood: "穏やかで親しみやすい表情",
          environment: "明るいカフェの窓際"
        },
        {
          angle: "背後から見下ろす俯瞰",
          shot: "広角で周囲の状況を含む",
          lighting: "夕暮れのオレンジ色の光",
          mood: "孤独と静けさ",
          environment: "人気のない公園のベンチ"
        },
        {
          angle: "真横からのプロファイル",
          shot: "上半身のミディアムショット",
          lighting: "側面からのスポットライト",
          mood: "考え込む真剣な表情",
          environment: "薄暗い室内、窓から光が差し込む"
        },
        {
          angle: "斜め下から見上げる",
          shot: "膝上までのミディアムロング",
          lighting: "明るい日差しが全体を照らす",
          mood: "希望に満ちた前向きな雰囲気",
          environment: "青空の広がる屋外"
        },
        {
          angle: "真上からの俯瞰ショット",
          shot: "作業している手元に焦点",
          lighting: "均一な白色照明",
          mood: "集中している様子",
          environment: "整理された机の上"
        },
        {
          angle: "目線の高さで正面",
          shot: "顔のクローズアップ",
          lighting: "柔らかいリムライト",
          mood: "感情が表情に現れている",
          environment: "ぼかした背景"
        },
        {
          angle: "斜め上から見下ろす",
          shot: "全身を含む引きのショット",
          lighting: "曇り空の拡散光",
          mood: "疲労感や重圧を感じる",
          environment: "雨の日の街角"
        },
        {
          angle: "横から捉えたウォーキングショット",
          shot: "腰から上のミディアムショット",
          lighting: "店の灯りが顔を照らす",
          mood: "活気と動きのある雰囲気",
          environment: "夜の繁華街"
        },
        {
          angle: "やや下から見上げる",
          shot: "膝下までのロングショット",
          lighting: "朝の清々しい光",
          mood: "新しい一日の始まりを感じる",
          environment: "朝日が差し込む駅のホーム"
        },
        {
          angle: "背中越しのオーバーショルダー",
          shot: "見ている対象物に焦点",
          lighting: "画面の光が顔を照らす",
          mood: "集中して画面を見つめる",
          environment: "オフィスのデスク"
        },
        {
          angle: "斜め横から接近した視点",
          shot: "顔と手元が見えるショット",
          lighting: "温かみのある間接照明",
          mood: "リラックスした穏やかな時間",
          environment: "自宅のリビング"
        },
        {
          angle: "ローアングルで足元から",
          shot: "全身を下から捉える",
          lighting: "強い影を作る直射日光",
          mood: "威厳や存在感を強調",
          environment: "階段や坂道"
        },
        {
          angle: "正面やや上から",
          shot: "胸から上のクローズアップ",
          lighting: "柔らかいディフューズ光",
          mood: "優しさや温もりを感じる",
          environment: "家庭的な室内"
        },
        {
          angle: "遠くから望遠で捉える",
          shot: "周囲の環境を含む超ロング",
          lighting: "自然な屋外の光",
          mood: "広大さや開放感",
          environment: "山や海などの自然の中"
        },
        {
          angle: "真正面のシンメトリー構図",
          shot: "上半身のポートレート",
          lighting: "均等な両側からの光",
          mood: "安定感とバランス",
          environment: "シンプルな背景"
        },
        {
          angle: "斜め下からの動的なアングル",
          shot: "動きを捉えたアクションショット",
          lighting: "逆光で輪郭を強調",
          mood: "エネルギッシュで躍動感",
          environment: "スポーツ施設や運動場"
        },
        {
          angle: "横から見た歩行シーン",
          shot: "腰から上を追従するパン",
          lighting: "街灯が断続的に照らす",
          mood: "日常の一コマ",
          environment: "夜の住宅街"
        },
        {
          angle: "やや俯瞰で斜めから",
          shot: "机や作業台を含むショット",
          lighting: "タスクライトのスポット",
          mood: "作業に没頭している様子",
          environment: "工房やアトリエ"
        },
        {
          angle: "目線より少し上から",
          shot: "座っている姿を捉える",
          lighting: "窓からの自然光",
          mood: "思索に耽る静かな時間",
          environment: "図書館や書斎"
        },
        {
          angle: "真横からのフラットな視点",
          shot: "立ち姿の全身",
          lighting: "均一なスタジオ照明",
          mood: "ニュートラルで客観的",
          environment: "白い背景のスタジオ"
        },
        {
          angle: "斜め上から見下ろす視点",
          shot: "複数人を含む群衆ショット",
          lighting: "イベント照明の明るい光",
          mood: "賑やかで活気に満ちた",
          environment: "お祭りやイベント会場"
        },
        {
          angle: "低い位置からのアップ",
          shot: "顔だけの超クローズアップ",
          lighting: "強いコントラストの照明",
          mood: "緊張感や緊迫した雰囲気",
          environment: "暗い部屋"
        },
        {
          angle: "やや斜めの自然な視点",
          shot: "日常的な動作を捉える",
          lighting: "午後の柔らかい光",
          mood: "何気ない日常の幸せ",
          environment: "公園や街中"
        },
        {
          angle: "背後から肩越しに",
          shot: "見ている風景を共有する構図",
          lighting: "景色からの反射光",
          mood: "憧れや期待感",
          environment: "展望台や窓際"
        },
        {
          angle: "真下から見上げる極端なローアングル",
          shot: "全身と空を含む",
          lighting: "直射日光の強い光",
          mood: "圧倒的な存在感",
          environment: "開けた屋外"
        },
        {
          angle: "斜め下からの親密な距離",
          shot: "顔と手元が見える近接ショット",
          lighting: "キャンドルや暖炉の温かい光",
          mood: "親密で個人的な雰囲気",
          environment: "落ち着いた室内"
        },
        {
          angle: "正面から少し左寄りの視点",
          shot: "上半身のビジネスショット",
          lighting: "明るく清潔感のある照明",
          mood: "プロフェッショナルで信頼感",
          environment: "オフィスや会議室"
        },
        {
          angle: "高い位置からの完全俯瞰",
          shot: "空間全体を捉える",
          lighting: "天井照明の均一な光",
          mood: "客観的で全体を俯瞰する",
          environment: "会議室やホール"
        },
        {
          angle: "斜め後ろから追いかける視点",
          shot: "背中と進む先を含む",
          lighting: "前方からの光",
          mood: "前進や旅立ちの予感",
          environment: "道路やトンネル"
        }
      ];

      // ========================================
      // テイスト別スタイル指示
      // ========================================
      function getTasteStyleInstruction(taste) {
        const styles = {
          photorealistic: [
            "Style: Photorealistic, high-quality photograph",
            "Quality: Professional photography with natural lighting and depth of field",
            "Details: Realistic textures, accurate colors, authentic composition"
          ],
          deformed: [
            "Style: Cute deformed illustration with simplified shapes",
            "Quality: Playful and charming character design",
            "Details: Exaggerated proportions, rounded features, vibrant colors"
          ],
          handdrawn: [
            "Style: Hand-drawn sketch with pencil or ink texture",
            "Quality: Artistic hand-crafted feel with visible strokes",
            "Details: Sketchy lines, organic texture, traditional art medium appearance"
          ],
          detailed: [
            "Style: Highly detailed and intricate illustration",
            "Quality: Precise, meticulous rendering with fine details",
            "Details: Complex textures, elaborate patterns, rich visual information"
          ],
          pictogram: [
            "Style: Simple pictogram icon with minimalist design",
            "Quality: Clean, clear, easily recognizable symbols",
            "Details: Flat colors, minimal details, strong silhouettes, universal visual language"
          ]
        };
        
        return styles[taste] || styles.photorealistic;
      }

      // ========================================
      // 使用済みバリアントの管理
      // ========================================
      let usedVariantIndices = [];

      function resetUsedVariants() {
        usedVariantIndices = [];
      }

      function getUniqueVariant() {
        if (usedVariantIndices.length >= VISUAL_VARIANTS.length) {
          // 全て使い切ったらリセット
          resetUsedVariants();
        }
        
        // 未使用のインデックスから選ぶ
        const availableIndices = [];
        for (let i = 0; i < VISUAL_VARIANTS.length; i++) {
          if (!usedVariantIndices.includes(i)) {
            availableIndices.push(i);
          }
        }
        
        const randomIndex = availableIndices[Math.floor(Math.random() * availableIndices.length)];
        usedVariantIndices.push(randomIndex);
        return VISUAL_VARIANTS[randomIndex];
      }

      // ========================================
      // clientToken 取得（OpenAI ChatKit の疎通確認用）
      // ========================================
      async function getToken() {
        $btnToken.disabled = true;
        $statusToken.classList.remove("ok","error");
        $statusToken.textContent = "接続中…";
        try {
          const resp = await fetch(`${BACKEND}/api/create-session`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ userId: $userId.value || "stage-user" })
          });
          const data = await resp.json().catch(() => ({}));
          if (resp.ok && data.clientToken) {
            lastClientToken = data.clientToken;
            $statusToken.classList.add("ok");
            $statusToken.textContent = "接続OK：clientToken 取得に成功しました。";
            console.log("[client] clientToken:", data.clientToken);
          } else {
            $statusToken.classList.add("error");
            $statusToken.textContent = "接続エラー：clientToken が返りませんでした。\n" + JSON.stringify(data);
            console.error("[client] error payload:", data);
          }
        } catch (e) {
          $statusToken.classList.add("error");
          $statusToken.textContent = "接続エラー：ネットワークまたはCORSで失敗。";
          console.error("[client] fetch error:", e);
        } finally {
          $btnToken.disabled = false;
        }
      }

      // ========================================
      // 文章分析：意味のある文章を抽出
      // ========================================
      function extractMeaningfulSentences(text) {
        const sentences = (text || "")
          .split(/(?<=[。！？\?\!])|\n+/g)
          .map(s => s.trim())
          .filter(s => s.length >= 15); // 短すぎる文は除外
        
        return sentences;
      }

      // ========================================
      // チャンク作成：長さに応じて1〜5枚
      // ========================================
      function createChunks(text) {
        const sentences = extractMeaningfulSentences(text);
        
        if (sentences.length === 0) {
          return [(text || "").slice(0, 200)];
        }

        // 文章の長さに応じて枚数を決定
        const totalLength = text.length;
        let numImages = 1;
        if (totalLength > 1500) numImages = 5;
        else if (totalLength > 1000) numImages = 4;
        else if (totalLength > 600) numImages = 3;
        else if (totalLength > 300) numImages = 2;

        // 文章を均等に分散させる
        const chunks = [];
        const step = Math.max(1, Math.floor(sentences.length / numImages));
        
        for (let i = 0; i < numImages && i * step < sentences.length; i++) {
          const sentenceIndex = i * step;
          chunks.push(sentences[sentenceIndex]);
        }

        return chunks;
      }

      // ========================================
      // プロンプト構築：バリアント適用
      // ========================================
      function buildPromptWithVariant(content, variant, taste) {
        const tasteInstructions = getTasteStyleInstruction(taste);
        
        return [
          "Create an image based on the following specifications:",
          "",
          "【Subject/Content】",
          content,
          "",
          "【Style Instructions】",
          ...tasteInstructions,
          "",
          "【Visual Specifications】",
          `Camera Angle: ${variant.angle}`,
          `Shot Type: ${variant.shot}`,
          `Lighting: ${variant.lighting}`,
          `Mood/Atmosphere: ${variant.mood}`,
          `Environment/Background: ${variant.environment}`,
          "",
          "【Critical Requirements】",
          "- Japanese people with natural Japanese features (skin tone, facial structure, hair)",
          "- Absolutely NO TEXT, NO LETTERS, NO SIGNS, NO WATERMARKS in the image",
          "- Natural and contextually appropriate background",
          "",
          "【Anatomical Accuracy - MANDATORY】",
          "- EXACTLY 2 arms per person (left arm and right arm only)",
          "- EXACTLY 2 legs per person (left leg and right leg only)",
          "- EXACTLY 5 fingers on each hand (thumb, index, middle, ring, pinky)",
          "- Normal human body proportions and structure",
          "- No extra limbs, no missing limbs, no deformed body parts",
          "",
          "【Cultural Accuracy for Japan - MANDATORY】",
          "- Indoor scenes: People MUST be barefoot, wearing socks, or wearing indoor slippers (no outdoor shoes inside)",
          "- Yoga/exercise mats: Only used indoors on wooden floors or tatami, NEVER outdoors on ground/grass",
          "- Remove outdoor shoes at entrance (genkan) when entering homes",
          "- Tatami rooms: Always barefoot or wearing socks only, no slippers",
          "- Follow Japanese customs and daily life practices accurately"
        ].join("\n");
      }

      // ========================================
      // カード作成（ダウンロード & 再生成）
      // ========================================
      function appendImageCard({ src, prompt, index, variantInfo, taste, aspectRatio }) {
        const card = document.createElement("div");
        card.className = "card";
        card.dataset.prompt = prompt;
        card.dataset.index = String(index);
        card.dataset.taste = taste;
        card.dataset.aspectRatio = aspectRatio;

        const meta = document.createElement("div");
        meta.className = "meta";
        meta.textContent = `#${index + 1}`;

        const img = new Image();
        img.className = "preview";
        img.src = src;

        const actions = document.createElement("div");
        actions.className = "actions";

        const a = document.createElement("a");
        a.href = src;
        a.download = `illustauto_${Date.now()}_${index + 1}.png`;
        a.textContent = "ダウンロード";
        a.className = "btn-dl";

        const re = document.createElement("button");
        re.className = "btn-re";
        re.textContent = "この画像を再生成";
        re.addEventListener("click", async () => {
          try {
            re.disabled = true;
            re.textContent = "再生成中…";
            
            // 再生成時は新しいバリアントと現在のテイスト・アスペクト比を使用
            const newVariant = getUniqueVariant();
            const content = card.dataset.prompt.split("【Subject/Content】")[1].split("【Style Instructions】")[0].trim();
            const currentTaste = card.dataset.taste || "photorealistic";
            const currentAspectRatio = card.dataset.aspectRatio || "1:1";
            const newPrompt = buildPromptWithVariant(content, newVariant, currentTaste);
            
            const resp = await fetch(`${BACKEND}/api/generate-test-image`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ 
                prompt: newPrompt, 
                provider: "google",
                aspectRatio: currentAspectRatio
              })
            });
            const data = await resp.json().catch(() => ({}));
            if (resp.ok && (data.dataUrl || data.url)) {
              const newSrc = data.dataUrl || data.url;
              img.src = newSrc;
              a.href = newSrc;
              a.download = `illustauto_${Date.now()}_${index + 1}.png`;
              meta.textContent = `#${index + 1}`;
              card.dataset.prompt = newPrompt;
            } else {
              alert("再生成エラー: " + JSON.stringify(data));
              console.error("[client] regenerate error:", data);
            }
          } catch (e) {
            alert("再生成エラー：ネットワークで失敗");
            console.error("[client] regenerate fetch error:", e);
          } finally {
            re.disabled = false;
            re.textContent = "この画像を再生成";
          }
        });

        actions.appendChild(a);
        actions.appendChild(re);
        card.appendChild(meta);
        card.appendChild(img);
        card.appendChild(actions);
        $gallery.appendChild(card);
      }

      // ========================================
      // 画像生成メイン処理
      // ========================================
      async function generateAuto() {
        const article = $article.value || "";
        const taste = $taste.value || "photorealistic";
        const aspectRatio = $aspectRatio.value || "1:1";
        const chunks = createChunks(article);

        $statusGen.classList.remove("ok","error");
        if (chunks.length === 0) {
          $statusGen.classList.add("error");
          $statusGen.textContent = "本文が空です。";
          return;
        }

        const origLabel = $btnGenerate.textContent;
        $btnGenerate.disabled = true;
        $btnGenerate.textContent = "生成中…";
        
        // バリアント使用履歴をリセット
        resetUsedVariants();

        let success = 0;
        try {
          for (let idx = 0; idx < chunks.length; idx++) {
            $statusGen.textContent = `生成中… (${idx + 1}/${chunks.length})`;

            const variant = getUniqueVariant();
            const prompt = buildPromptWithVariant(chunks[idx], variant, taste);
            
            console.log(`[client] Generating #${idx + 1} with variant:`, variant.shot, `taste: ${taste}, aspectRatio: ${aspectRatio}`);

            const resp = await fetch(`${BACKEND}/api/generate-test-image`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ 
                prompt, 
                provider: "google",
                aspectRatio: aspectRatio
              })
            });
            const data = await resp.json().catch(() => ({}));

            if (resp.ok && (data.dataUrl || data.url)) {
              success++;
              const src = data.dataUrl || data.url;
              appendImageCard({ 
                src, 
                prompt, 
                index: idx,
                variantInfo: variant,
                taste: taste,
                aspectRatio: aspectRatio
              });
              console.log(`[client] Generated #${idx + 1} successfully`);
            } else {
              console.error(`[client] Error on #${idx + 1}:`, data);
            }
          }

          if (success > 0) {
            $statusGen.classList.add("ok");
            $statusGen.textContent = `生成完了：${success}枚を追加しました。`;
          } else {
            $statusGen.classList.add("error");
            $statusGen.textContent = "生成エラー：1枚も生成できませんでした。";
          }
        } catch (e) {
          $statusGen.classList.add("error");
          $statusGen.textContent = "生成エラー：ネットワークで失敗。";
          console.error("[client] generateAuto error:", e);
        } finally {
          $btnGenerate.disabled = false;
          $btnGenerate.textContent = (success > 0) ? "全てを再生成" : origLabel;
        }
      }

      // ========================================
      // 初期化
      // ========================================
      document.addEventListener("DOMContentLoaded", () => {
        document.getElementById("btnToken").addEventListener("click", getToken);
        document.getElementById("btnGenerate").addEventListener("click", generateAuto);
      });
    </script>
  </body>
</html>

<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IllustAuto - AI画像生成</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      color: #333;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      padding: 40px;
      position: relative;
    }
    
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 2px solid #f0f0f0;
    }
    
    .logo-section {
      display: flex;
      align-items: center;
    }
    
    .logo {
      font-size: 32px;
      margin-right: 15px;
    }
    
    .logo-text {
      font-size: 24px;
      font-weight: 700;
      color: #667eea;
    }
    
    .user-section {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .user-info {
      font-size: 14px;
      color: #666;
    }
    
    .logout-btn {
      padding: 8px 16px;
      background: #dc3545;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
    }
    
    .logout-btn:hover {
      background: #c82333;
    }
    
    .form-section {
      background: #f8f9fa;
      padding: 30px;
      border-radius: 15px;
      margin-bottom: 30px;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    label {
      display: block;
      margin-bottom: 8px;
      color: #555;
      font-weight: 500;
    }
    
    textarea {
      width: 100%;
      min-height: 150px;
      padding: 15px;
      border: 2px solid #e1e5e9;
      border-radius: 10px;
      font-size: 16px;
      resize: vertical;
      font-family: inherit;
    }
    
    textarea:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }
    
    select {
      width: 100%;
      padding: 15px;
      border: 2px solid #e1e5e9;
      border-radius: 10px;
      font-size: 16px;
      background: white;
    }
    
    select:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .generate-btn {
      width: 100%;
      padding: 18px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s;
      margin-top: 20px;
    }
    
    .generate-btn:hover {
      transform: translateY(-2px);
    }
    
    .generate-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }
    
    .results-section {
      margin-top: 30px;
    }
    
    .images-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    
    .image-card {
      background: white;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      overflow: hidden;
      transition: transform 0.3s;
    }
    
    .image-card:hover {
      transform: translateY(-5px);
    }
    
    .image-container {
      position: relative;
      width: 100%;
      height: 250px;
      background: #f8f9fa;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .image-container img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }
    
    .image-info {
      padding: 20px;
    }
    
    .image-title {
      font-weight: 600;
      color: #333;
      margin-bottom: 10px;
    }
    
    .image-prompt {
      font-size: 14px;
      color: #666;
      margin-bottom: 15px;
    }
    
    .download-btn {
      width: 100%;
      padding: 12px;
      background: #28a745;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
    }
    
    .download-btn:hover {
      background: #218838;
    }
    
    .regenerate-btn {
      padding: 12px;
      background: #6f42c1;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
      font-size: 14px;
    }
    
    .regenerate-btn:hover {
      background: #5a32a3;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }
    
    .loading-spinner {
      display: inline-block;
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 15px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .message {
      margin: 15px 0;
      padding: 15px;
      border-radius: 8px;
      font-size: 14px;
    }
    
    .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    .info { background: #cce7ff; color: #004085; border: 1px solid #b3d7ff; }
    
    .hidden { display: none; }
    
    /* モーダルスタイル */
    .modal {
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .modal-content {
      background: white;
      border-radius: 15px;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
      border-bottom: 1px solid #eee;
    }
    
    .modal-header h3 {
      margin: 0;
      color: #333;
    }
    
    .close {
      font-size: 24px;
      cursor: pointer;
      color: #999;
    }
    
    .close:hover {
      color: #333;
    }
    
    .modal-body {
      padding: 20px;
    }
    
    .modal-footer {
      padding: 20px;
      border-top: 1px solid #eee;
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }
    
    @media (max-width: 768px) {
      .form-row {
        grid-template-columns: 1fr;
      }
      
      .container {
        padding: 20px;
      }
      
      .header {
        flex-direction: column;
        text-align: center;
        gap: 15px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="logo-section">
        <div class="logo">🎨</div>
        <div class="logo-text">IllustAuto</div>
      </div>
      <div class="user-section">
        <div class="user-info" id="userInfo">Loading...</div>
        <button class="logout-btn" onclick="logout()">ログアウト</button>
      </div>
    </div>

    <div class="form-section">
      <h2>📝 画像生成</h2>
      <div class="form-group">
        <label for="content">記事の内容</label>
        <textarea 
          id="content" 
          placeholder="画像を生成したい記事の内容を入力してください。見出しがある場合は ## 見出し の形式で記載してください。"
          maxlength="5000"
        ></textarea>
        <div style="text-align: right; font-size: 12px; color: #666; margin-top: 5px;">
          <span id="charCount">0</span> / 5000文字
        </div>
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label for="style">画像スタイル</label>
          <select id="style">
            <option value="photo">写真画質</option>
            <option value="deformed">デフォルメアニメ</option>
            <option value="watercolor">手書き水彩画</option>
            <option value="detailed">精密イラスト</option>
            <option value="pictogram">ピクトグラム</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="aspectRatio">アスペクト比</label>
          <select id="aspectRatio">
            <option value="16:9">🖥️ 横長 (16:9)</option>
            <option value="1:1" selected>⬜ 正方形 (1:1)</option>
            <option value="9:16">📱 縦長 (9:16)</option>
          </select>
        </div>
      </div>
      
      <button class="generate-btn" onclick="generateImages()" id="generateBtn">
        🚀 画像を生成する
      </button>
    </div>

    <div class="results-section" id="resultsSection">
      <div id="loadingSection" class="loading hidden">
        <div class="loading-spinner"></div>
        <div id="loadingMessage">AIが文章を分割しています...</div>
        <div style="font-size: 14px; margin-top: 10px;">しばらくお待ちください</div>
      </div>
      
      <div id="imagesSection" class="hidden">
        <h2>🖼️ 生成された画像</h2>
        <div id="imagesGrid" class="images-grid"></div>
      </div>
    </div>

    <div id="message"></div>
  </div>


  <script>
    const BACKEND = 'https://illustauto-backend-production.up.railway.app';
    let userEmail = '';

    // 認証チェック（直接アクセス禁止）
    function checkAuth() {
      const token = localStorage.getItem('access_token');
      
      console.log('🔍 認証チェック実行中...');
      console.log('🔑 トークン状況:', token ? '存在' : '未保存');
      
      if (!token) {
        console.log('❌ 認証トークンなし - login.htmlにリダイレクト');
        window.location.href = './login.html';
        return false;
      }
      
      console.log('✅ 認証トークン確認済み');
      return true;
    }

    // ユーザー情報取得
    async function getUserInfo() {
      const token = localStorage.getItem('access_token');
      console.log('👤 ユーザー情報取得開始...');
      
      try {
        const xhr = new XMLHttpRequest();
        xhr.open('GET', `${BACKEND}/api/auth/me`, true);
        xhr.setRequestHeader('Authorization', `Bearer ${token}`);
        
        xhr.onload = function() {
          console.log('📡 サーバーレスポンス:', xhr.status, xhr.responseText);
          
          if (xhr.status === 200) {
            const data = JSON.parse(xhr.responseText);
            userEmail = data.user.email;
            document.getElementById('userInfo').textContent = `👤 ${data.user.email}`;
            console.log('✅ ユーザー情報取得成功:', data.user.email);
          } else {
            console.log('❌ 認証失敗 - ログアウト実行');
            alert('ログアウトします');
            logout();
          }
        };
        
        xhr.onerror = function() {
          console.log('❌ ネットワークエラー - ログアウト実行');
          alert('ログアウトします');
          logout();
        };
        
        xhr.send();
      } catch (error) {
        console.log('❌ リクエストエラー:', error);
        alert('ログアウトします');
        logout();
      }
    }

    // ログアウト
    function logout() {
      localStorage.removeItem('access_token');
      localStorage.removeItem('refresh_token');
      window.location.href = './login.html';
    }

    // メッセージ表示
    function showMessage(text, type = 'info') {
      const messageDiv = document.getElementById('message');
      messageDiv.className = `message ${type}`;
      messageDiv.textContent = text;
      messageDiv.style.display = 'block';
      
      setTimeout(() => messageDiv.style.display = 'none', 5000);
    }

    // 文字数カウント
    function updateCharCount() {
      const content = document.getElementById('content').value;
      document.getElementById('charCount').textContent = content.length;
    }

    // 画像生成
    async function generateImages() {
      const content = document.getElementById('content').value.trim();
      const style = document.getElementById('style').value;
      const aspectRatio = document.getElementById('aspectRatio').value;
      
      if (!content) {
        showMessage('記事の内容を入力してください', 'error');
        return;
      }

      if (content.length > 5000) {
        showMessage('記事の内容は5000文字以内にしてください', 'error');
        return;
      }

      const generateBtn = document.getElementById('generateBtn');
      const loadingSection = document.getElementById('loadingSection');
      const imagesSection = document.getElementById('imagesSection');
      
      generateBtn.disabled = true;
      generateBtn.textContent = '生成中...';
      loadingSection.classList.remove('hidden');
      imagesSection.classList.add('hidden');
      
      // AI分割メッセージを表示してから画像生成メッセージに変更
      const loadingMessage = document.getElementById('loadingMessage');
      loadingMessage.textContent = 'AIが文章を分割しています...';
      setTimeout(() => {
        loadingMessage.textContent = '画像を生成しています...';
      }, 2000);

      try {
        const token = localStorage.getItem('access_token');
        const xhr = new XMLHttpRequest();
        xhr.open('POST', `${BACKEND}/api/generate`, true);
        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.setRequestHeader('Authorization', `Bearer ${token}`);
        
        xhr.onload = function() {
          generateBtn.disabled = false;
          generateBtn.textContent = '🚀 画像を生成する';
          loadingSection.classList.add('hidden');
          
          if (xhr.status === 200) {
            const data = JSON.parse(xhr.responseText);
            if (data.images && data.images.length > 0) {
              displayImages(data.images);
              showMessage(`${data.images.length}枚の画像を生成しました！`, 'success');
            } else {
              showMessage('画像の生成に失敗しました', 'error');
            }
          } else if (xhr.status === 401) {
            logout();
          } else {
            const errorData = JSON.parse(xhr.responseText);
            showMessage(errorData.message || 'エラーが発生しました', 'error');
          }
        };
        
        xhr.onerror = function() {
          generateBtn.disabled = false;
          generateBtn.textContent = '🚀 画像を生成する';
          loadingSection.classList.add('hidden');
          showMessage('ネットワークエラーが発生しました', 'error');
        };
        
        xhr.send(JSON.stringify({
          content: content,
          taste: style,
          aspectRatio: aspectRatio
        }));
        
      } catch (error) {
        generateBtn.disabled = false;
        generateBtn.textContent = '🚀 画像を生成する';
        loadingSection.classList.add('hidden');
        showMessage('エラーが発生しました', 'error');
      }
    }

    // 画像表示
    function displayImages(images) {
      const grid = document.getElementById('imagesGrid');
      const section = document.getElementById('imagesSection');
      
      // 画像配列を保存（修正機能で使用）
      originalImages = images;
      
      grid.innerHTML = '';
      
      images.forEach((image, index) => {
        const card = document.createElement('div');
        card.className = 'image-card';
        
        card.innerHTML = `
          <div class="image-container">
            <img src="${image.dataUrl}" alt="${image.title}" />
          </div>
          <div class="image-info">
            <div class="image-title">${image.title || `画像 ${index + 1}`}</div>
            ${image.heading ? `<div style="font-size: 12px; color: #888; margin-bottom: 5px;">📑 ${image.heading}</div>` : ''}
            <div style="display: flex; gap: 10px; margin-top: 10px;">
              <button class="download-btn" onclick="downloadImage('${image.title || `画像_${index + 1}`}', '${image.dataUrl}')" style="flex: 1;">
                ⬇️ ダウンロード
              </button>
              <button class="regenerate-btn" onclick="executeRegenerationDirect(${index})" style="flex: 1;">
                🔄 修正
              </button>
            </div>
            <!-- 修正UI常時表示 -->
            <div style="background: #f8f9fa; border: 1px solid #ddd; border-radius: 8px; padding: 10px; margin-top: 10px;">
              <div style="display: flex; gap: 10px;">
                <select id="regenerate-style-${index}" style="flex: 1; padding: 6px; border: 1px solid #ccc; border-radius: 4px;">
                  <option value="photo">写真画質</option>
                  <option value="deformed">デフォルメアニメ</option>
                  <option value="watercolor">手書き水彩画</option>
                  <option value="detailed">精密イラスト</option>
                  <option value="pictogram">ピクトグラム</option>
                </select>
                <select id="regenerate-ratio-${index}" style="flex: 1; padding: 6px; border: 1px solid #ccc; border-radius: 4px;">
                  <option value="16:9">横長</option>
                  <option value="1:1">正方形</option>
                  <option value="9:16">縦長</option>
                </select>
              </div>
            </div>
          </div>
        `;
        
        grid.appendChild(card);
      });
      
      section.classList.remove('hidden');
    }

    // 画像ダウンロード
    function downloadImage(title, dataUrl) {
      const a = document.createElement('a');
      a.href = dataUrl;
      
      // dataUrlの形式に応じて適切な拡張子を設定
      let extension = '.png';
      if (dataUrl.startsWith('data:image/svg+xml')) {
        extension = '.svg';
      } else if (dataUrl.startsWith('data:image/jpeg')) {
        extension = '.jpg';
      } else if (dataUrl.startsWith('data:image/webp')) {
        extension = '.webp';
      }
      
      a.download = `illustauto_${title}${extension}`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }

    // 画像再生成関連
    let originalImages = [];

    // 再生成オプションの表示（インライン表示）
    function showRegenerateOptions(imageIndex) {
      if (imageIndex < 0 || !originalImages[imageIndex]) {
        showMessage('修正対象の画像が見つかりません', 'error');
        return;
      }

      // 既存の修正UIを削除
      const existingUI = document.querySelector('.regenerate-options-ui');
      if (existingUI) {
        existingUI.remove();
      }

      // 画像カードを特定
      const imageCards = document.querySelectorAll('.image-container');
      const imageCard = imageCards[imageIndex];
      if (!imageCard) {
        showMessage('画像要素が見つかりません', 'error');
        return;
      }

      const currentStyle = document.getElementById('style').value;
      const currentAspectRatio = document.getElementById('aspectRatio').value;

      // インライン修正UIを作成
      const regenerateUI = document.createElement('div');
      regenerateUI.className = 'regenerate-options-ui';
      regenerateUI.innerHTML = `
        <div style="background: #f8f9fa; border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin-top: 10px;">
          <h4 style="margin: 0 0 10px 0; color: #333;">画像修正オプション</h4>
          
          <div style="display: flex; gap: 15px; margin-bottom: 15px;">
            <div style="flex: 1;">
              <label style="display: block; margin-bottom: 5px; font-weight: bold;">テイスト:</label>
              <select id="regenerate-style-${imageIndex}" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                <option value="photo" ${currentStyle === 'photo' ? 'selected' : ''}>写真画質</option>
                <option value="deformed" ${currentStyle === 'deformed' ? 'selected' : ''}>デフォルメアニメ</option>
                <option value="watercolor" ${currentStyle === 'watercolor' ? 'selected' : ''}>手書き水彩画</option>
                <option value="detailed" ${currentStyle === 'detailed' ? 'selected' : ''}>精密イラスト</option>
                <option value="pictogram" ${currentStyle === 'pictogram' ? 'selected' : ''}>ピクトグラム</option>
              </select>
            </div>
            
            <div style="flex: 1;">
              <label style="display: block; margin-bottom: 5px; font-weight: bold;">サイズ:</label>
              <select id="regenerate-ratio-${imageIndex}" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                <option value="16:9" ${currentAspectRatio === '16:9' ? 'selected' : ''}>横長 (16:9)</option>
                <option value="1:1" ${currentAspectRatio === '1:1' ? 'selected' : ''}>正方形 (1:1)</option>
                <option value="9:16" ${currentAspectRatio === '9:16' ? 'selected' : ''}>縦長 (9:16)</option>
              </select>
            </div>
          </div>
          
          <div style="display: flex; gap: 10px;">
            <button onclick="executeRegeneration(${imageIndex})" style="flex: 1; padding: 10px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
              🔄 修正実行
            </button>
            <button onclick="cancelRegeneration()" style="flex: 1; padding: 10px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">
              ✖️ キャンセル
            </button>
          </div>
        </div>
      `;

      imageCard.appendChild(regenerateUI);
    }

    function executeRegeneration(imageIndex) {
      const styleSelect = document.getElementById(`regenerate-style-${imageIndex}`);
      const ratioSelect = document.getElementById(`regenerate-ratio-${imageIndex}`);
      
      if (!styleSelect || !ratioSelect) {
        showMessage('修正オプションが見つかりません', 'error');
        return;
      }
      
      const selectedStyle = styleSelect.value;
      const selectedRatio = ratioSelect.value;
      
      // UIを削除
      cancelRegeneration();
      
      // 再生成実行
      autoRegenerateImage(imageIndex, selectedStyle, selectedRatio);
    }

    // 直接再生成（常時表示されているUI用）
    function executeRegenerationDirect(imageIndex) {
      const styleSelect = document.getElementById(`regenerate-style-${imageIndex}`);
      const ratioSelect = document.getElementById(`regenerate-ratio-${imageIndex}`);
      
      if (!styleSelect || !ratioSelect) {
        showMessage('修正オプションが見つかりません', 'error');
        return;
      }
      
      const selectedStyle = styleSelect.value;
      const selectedRatio = ratioSelect.value;
      
      // 直接再生成実行（UIは削除しない）
      autoRegenerateImage(imageIndex, selectedStyle, selectedRatio);
    }

    function cancelRegeneration() {
      const existingUI = document.querySelector('.regenerate-options-ui');
      if (existingUI) {
        existingUI.remove();
      }
    }

    // 自動的にプロンプトを少し修正して再生成
    async function autoRegenerateImage(imageIndex, customStyle = null, customAspectRatio = null) {
      if (imageIndex < 0 || !originalImages[imageIndex]) {
        showMessage('修正対象の画像が見つかりません', 'error');
        return;
      }

      const originalImage = originalImages[imageIndex];
      
      // ボタンを無効化して状態表示
      const regenerateButtons = document.querySelectorAll('.regenerate-btn');
      const targetBtn = regenerateButtons[imageIndex];
      if (targetBtn) {
        targetBtn.disabled = true;
        targetBtn.textContent = '修正中...';
      }

      try {
        const token = localStorage.getItem('access_token');
        
        // 自動修正指示を生成（プロンプトを少し変更）
        const autoInstructions = generateAutoInstructions(originalImage.prompt);
        
        const xhr = new XMLHttpRequest();
        xhr.open('POST', `${BACKEND}/api/regenerate`, true);
        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.setRequestHeader('Authorization', `Bearer ${token}`);

        xhr.onload = function() {
          // ボタン状態を復元
          if (targetBtn) {
            targetBtn.disabled = false;
            targetBtn.textContent = '🔄 修正';
          }

          if (xhr.status === 200) {
            const data = JSON.parse(xhr.responseText);
            if (data.success && data.image) {
              // 元の画像を修正版で置き換え（リアルタイム置換）
              originalImages[imageIndex] = data.image;
              displayImages(originalImages);
              showMessage(`画像 ${imageIndex + 1} を修正しました！`, 'success');
            } else {
              showMessage(data.message || '修正に失敗しました', 'error');
            }
          } else if (xhr.status === 401) {
            logout();
          } else {
            const errorData = JSON.parse(xhr.responseText);
            showMessage(errorData.message || '修正エラーが発生しました', 'error');
          }
        };

        xhr.onerror = function() {
          if (targetBtn) {
            targetBtn.disabled = false;
            targetBtn.textContent = '🔄 修正';
          }
          showMessage('ネットワークエラーが発生しました', 'error');
        };

        // ユーザー選択またはフォームの値を使用
        xhr.send(JSON.stringify({
          originalPrompt: originalImage.prompt,
          instructions: autoInstructions,
          style: customStyle || document.getElementById('style').value,
          aspectRatio: customAspectRatio || document.getElementById('aspectRatio').value
        }));

      } catch (error) {
        if (targetBtn) {
          targetBtn.disabled = false;
          targetBtn.textContent = '🔄 修正';
        }
        showMessage('修正エラーが発生しました', 'error');
      }
    }

    // 30種類以上の詳細なバリエーション（v1_backupから復元）
    const VISUAL_VARIANTS = [
      {
        angle: "正面から見上げるローアングル",
        shot: "全身を捉えた広角ショット",
        lighting: "逆光でシルエットを強調",
        mood: "力強さと決意を感じる雰囲気",
        environment: "都市の高層ビル群を背景に"
      },
      {
        angle: "真上から見下ろす俯瞰",
        shot: "対象を中心に配置した構図",
        lighting: "均等に明るい昼光",
        mood: "静寂で整然とした雰囲気",
        environment: "開けた広場や公園"
      },
      {
        angle: "斜め45度から見た視点",
        shot: "上半身をクローズアップ",
        lighting: "柔らかい自然光が横から",
        mood: "親しみやすく温かい雰囲気",
        environment: "カフェやリビングルーム"
      },
      {
        angle: "横から捉えたプロファイル",
        shot: "人物の横顔をフレームいっぱいに",
        lighting: "窓からの光がハイライトを作る",
        mood: "思索的で落ち着いた雰囲気",
        environment: "書斎や図書館"
      },
      {
        angle: "やや上から見下ろす視点",
        shot: "テーブル上の作業を捉える",
        lighting: "デスクライトの温かい光",
        mood: "集中と創造性を感じる雰囲気",
        environment: "オフィスや工房"
      },
      {
        angle: "地面すれすれの超ローアングル",
        shot: "足元から全身を見上げる構図",
        lighting: "強い影を作る夕日",
        mood: "ドラマチックで印象的な雰囲気",
        environment: "屋外の開けた場所"
      },
      {
        angle: "鳥の目線の真上から",
        shot: "複数人を配置したパターン構図",
        lighting: "均一な照明で影を最小限に",
        mood: "協調性とバランスを感じる雰囲気",
        environment: "会議室やスタジオ"
      },
      {
        angle: "目線の高さでの正面構図",
        shot: "顔を大きくクローズアップ",
        lighting: "前方から柔らかく照らす",
        mood: "親密で感情的な雰囲気",
        environment: "屋内の自然光が入る場所"
      },
      {
        angle: "下から見上げる迫力ある構図",
        shot: "建物や物体の威圧感を強調",
        lighting: "夜間の人工照明",
        mood: "威厳と力強さを感じる雰囲気",
        environment: "都市の夜景"
      },
      {
        angle: "斜め後ろからの視点",
        shot: "背中越しに前方を見る構図",
        lighting: "前方からの逆光",
        mood: "冒険心と期待を感じる雰囲気",
        environment: "自然の中や街の通り"
      },
      {
        angle: "真横からの平面的な視点",
        shot: "動きを捉えたアクションショット",
        lighting: "ストロボで動きを凍結",
        mood: "エネルギッシュで動的な雰囲気",
        environment: "スポーツ施設や屋外"
      },
      {
        angle: "やや下から煽る構図",
        shot: "対象の威厳を強調する配置",
        lighting: "下からの照明で劇的に",
        mood: "格式と権威を感じる雰囲気",
        environment: "大理石の建物内部"
      },
      {
        angle: "上から見下ろす俯瞰",
        shot: "作業中の手元をクローズアップ",
        lighting: "真上からの明るい照明",
        mood: "丁寧で繊細な雰囲気",
        environment: "キッチンや作業台"
      },
      {
        angle: "遠くから望遠で捉える",
        shot: "人物を風景の一部として",
        lighting: "自然な昼光",
        mood: "孤独と静けさを感じる雰囲気",
        environment: "広大な自然の中"
      },
      {
        angle: "目線より少し高い位置から",
        shot: "グループ全体を捉えた構図",
        lighting: "柔らかく均等な照明",
        mood: "調和と一体感を感じる雰囲気",
        environment: "集会所や広い室内"
      },
      {
        angle: "斜め上から見下ろす視点",
        shot: "座っている人物を捉える",
        lighting: "窓からの自然光",
        mood: "リラックスした穏やかな雰囲気",
        environment: "リビングやカフェ"
      },
      {
        angle: "極端なワイドアングル",
        shot: "空間の広がりを強調",
        lighting: "明暗差のあるコントラスト",
        mood: "開放感と広がりを感じる雰囲気",
        environment: "大きなホールや屋外"
      },
      {
        angle: "接写マクロ的な視点",
        shot: "細部を大きく捉える",
        lighting: "ソフトボックスで均一に",
        mood: "精密さと注意深さを感じる雰囲気",
        environment: "スタジオや研究室"
      },
      {
        angle: "斜めから捉えた三点透視",
        shot: "建物や空間の奥行きを強調",
        lighting: "夕暮れの斜光",
        mood: "ドラマチックで印象的な雰囲気",
        environment: "都市の街角"
      },
      {
        angle: "水平線上の目線で",
        shot: "対称的な構図",
        lighting: "均等な拡散光",
        mood: "バランスと調和を感じる雰囲気",
        environment: "モダンな建築内部"
      },
      {
        angle: "やや下から見上げる構図",
        shot: "人物の表情をクローズアップ",
        lighting: "前方からのソフトライト",
        mood: "希望と前向きさを感じる雰囲気",
        environment: "明るい室内"
      },
      {
        angle: "真後ろからの視点",
        shot: "後ろ姿を捉えた構図",
        lighting: "前方の明るい光に向かって",
        mood: "旅立ちと期待を感じる雰囲気",
        environment: "駅や空港"
      },
      {
        angle: "斜め下から煽る構図",
        shot: "全身を力強く捉える",
        lighting: "下からのアップライト",
        mood: "ヒロイックで勇敢な雰囲気",
        environment: "舞台や演壇"
      },
      {
        angle: "上から見下ろす高所視点",
        shot: "街並みや風景を一望",
        lighting: "晴天の自然光",
        mood: "爽快感と達成感を感じる雰囲気",
        environment: "高層ビルの屋上"
      },
      {
        angle: "目線より低い位置から",
        shot: "子供目線の構図",
        lighting: "柔らかい自然光",
        mood: "無邪気で純真な雰囲気",
        environment: "公園や遊び場"
      },
      {
        angle: "正面やや右寄りの視点",
        shot: "対話シーンを捉える",
        lighting: "三点照明で立体的に",
        mood: "親密で対話的な雰囲気",
        environment: "会議室や対面の場"
      },
      {
        angle: "遠景から広角で捉える",
        shot: "人物と環境を一体的に",
        lighting: "ゴールデンアワーの暖色光",
        mood: "ノスタルジックで情緒的な雰囲気",
        environment: "田園や海辺"
      },
      {
        angle: "横から捉えた動的構図",
        shot: "走る姿を流し撮り風に",
        lighting: "逆光気味のエッジライト",
        mood: "スピード感と躍動を感じる雰囲気",
        environment: "道路やトラック"
      },
      {
        angle: "斜め上からの鳥瞰",
        shot: "複雑な配置を整理して見せる",
        lighting: "明るく均一な照明",
        mood: "整然とした秩序を感じる雰囲気",
        environment: "工場や倉庫"
      },
      {
        angle: "極端なローアングルから",
        shot: "空と対象を対比させる構図",
        lighting: "逆光でシルエット化",
        mood: "壮大さと自由を感じる雰囲気",
        environment: "開けた野外"
      }
    ];

    let usedVariantIndices = [];
    
    function resetUsedVariants() {
      usedVariantIndices = [];
    }
    
    function getUniqueVariant() {
      if (usedVariantIndices.length >= VISUAL_VARIANTS.length) {
        resetUsedVariants();
      }
      
      let attempts = 0;
      let index;
      
      do {
        index = Math.floor(Math.random() * VISUAL_VARIANTS.length);
        attempts++;
      } while (usedVariantIndices.includes(index) && attempts < 50);
      
      usedVariantIndices.push(index);
      return VISUAL_VARIANTS[index];
    }

    // 自動修正指示を生成
    function generateAutoInstructions(originalPrompt) {
      const variant = getUniqueVariant();
      
      return `${variant.angle}で、${variant.shot}。${variant.lighting}を使い、${variant.mood}で、${variant.environment}の設定で修正してください。`;
    }

    // 初期化
    document.addEventListener('DOMContentLoaded', function() {
      console.log('🎯 app.html読み込み開始（同一ドメインモード）');
      
      // 最初に認証チェック
      if (!checkAuth()) {
        console.log('❌ 認証失敗 - 初期化中止');
        return;
      }
      
      console.log('✅ 認証チェック通過 - アプリ初期化開始');
      getUserInfo();
      
      // 文字数カウント
      document.getElementById('content').addEventListener('input', updateCharCount);
      
      // Enterキーでの生成防止
      document.getElementById('content').addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
          generateImages();
        }
      });
    });
  </script>
</body>
</html>

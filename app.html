<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IllustAuto - AIç”»åƒç”Ÿæˆ</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      color: #333;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      padding: 40px;
      position: relative;
    }
    
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 2px solid #f0f0f0;
    }
    
    .logo-section {
      display: flex;
      align-items: center;
    }
    
    .logo {
      font-size: 32px;
      margin-right: 15px;
    }
    
    .logo-text {
      font-size: 24px;
      font-weight: 700;
      color: #667eea;
    }
    
    .user-section {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .user-info {
      font-size: 14px;
      color: #666;
    }
    
    .logout-btn {
      padding: 8px 16px;
      background: #dc3545;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
    }
    
    .logout-btn:hover {
      background: #c82333;
    }
    
    .form-section {
      background: #f8f9fa;
      padding: 30px;
      border-radius: 15px;
      margin-bottom: 30px;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    label {
      display: block;
      margin-bottom: 8px;
      color: #555;
      font-weight: 500;
    }
    
    textarea {
      width: 100%;
      min-height: 150px;
      padding: 15px;
      border: 2px solid #e1e5e9;
      border-radius: 10px;
      font-size: 16px;
      resize: vertical;
      font-family: inherit;
    }
    
    textarea:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }
    
    select {
      width: 100%;
      padding: 15px;
      border: 2px solid #e1e5e9;
      border-radius: 10px;
      font-size: 16px;
      background: white;
    }
    
    select:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .generate-btn {
      width: 100%;
      padding: 18px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s;
      margin-top: 20px;
    }
    
    .generate-btn:hover {
      transform: translateY(-2px);
    }
    
    .generate-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }
    
    .results-section {
      margin-top: 30px;
    }
    
    .images-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    
    .image-card {
      background: white;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      overflow: hidden;
      transition: transform 0.3s;
    }
    
    .image-card:hover {
      transform: translateY(-5px);
    }
    
    .image-container {
      position: relative;
      width: 100%;
      height: 250px;
      background: #f8f9fa;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .image-container img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }
    
    .image-info {
      padding: 20px;
    }
    
    .image-title {
      font-weight: 600;
      color: #333;
      margin-bottom: 10px;
    }
    
    .image-prompt {
      font-size: 14px;
      color: #666;
      margin-bottom: 15px;
    }
    
    .download-btn {
      width: 100%;
      padding: 12px;
      background: #28a745;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
    }
    
    .download-btn:hover {
      background: #218838;
    }
    
    .regenerate-btn {
      padding: 12px;
      background: #6f42c1;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
      font-size: 14px;
    }
    
    .regenerate-btn:hover {
      background: #5a32a3;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }
    
    .loading-spinner {
      display: inline-block;
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 15px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .message {
      margin: 15px 0;
      padding: 15px;
      border-radius: 8px;
      font-size: 14px;
    }
    
    .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    .info { background: #cce7ff; color: #004085; border: 1px solid #b3d7ff; }
    
    .hidden { display: none; }
    
    /* ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¹ã‚¿ã‚¤ãƒ« */
    .modal {
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .modal-content {
      background: white;
      border-radius: 15px;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
      border-bottom: 1px solid #eee;
    }
    
    .modal-header h3 {
      margin: 0;
      color: #333;
    }
    
    .close {
      font-size: 24px;
      cursor: pointer;
      color: #999;
    }
    
    .close:hover {
      color: #333;
    }
    
    .modal-body {
      padding: 20px;
    }
    
    .modal-footer {
      padding: 20px;
      border-top: 1px solid #eee;
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }
    
    @media (max-width: 768px) {
      .form-row {
        grid-template-columns: 1fr;
      }
      
      .container {
        padding: 20px;
      }
      
      .header {
        flex-direction: column;
        text-align: center;
        gap: 15px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="logo-section">
        <div class="logo">ğŸ¨</div>
        <div class="logo-text">IllustAuto</div>
      </div>
      <div class="user-section">
        <div class="user-info" id="userInfo">Loading...</div>
        <button class="logout-btn" onclick="logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
      </div>
    </div>

    <div class="form-section">
      <h2>ğŸ“ ç”»åƒç”Ÿæˆ</h2>
      <div class="form-group">
        <label for="content">è¨˜äº‹ã®å†…å®¹</label>
        <textarea 
          id="content" 
          placeholder="ç”»åƒã‚’ç”Ÿæˆã—ãŸã„è¨˜äº‹ã®å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚è¦‹å‡ºã—ãŒã‚ã‚‹å ´åˆã¯ ## è¦‹å‡ºã— ã®å½¢å¼ã§è¨˜è¼‰ã—ã¦ãã ã•ã„ã€‚"
          maxlength="5000"
        ></textarea>
        <div style="text-align: right; font-size: 12px; color: #666; margin-top: 5px;">
          <span id="charCount">0</span> / 5000æ–‡å­—
        </div>
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label for="style">ç”»åƒã‚¹ã‚¿ã‚¤ãƒ«</label>
          <select id="style">
            <option value="photo">å†™çœŸç”»è³ª</option>
            <option value="deformed">ãƒ‡ãƒ•ã‚©ãƒ«ãƒ¡ã‚¢ãƒ‹ãƒ¡</option>
            <option value="watercolor">æ‰‹æ›¸ãæ°´å½©ç”»</option>
            <option value="detailed">ç²¾å¯†ã‚¤ãƒ©ã‚¹ãƒˆ</option>
            <option value="pictogram">ãƒ”ã‚¯ãƒˆã‚°ãƒ©ãƒ </option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="aspectRatio">ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”</label>
          <select id="aspectRatio">
            <option value="16:9">ğŸ–¥ï¸ æ¨ªé•· (16:9)</option>
            <option value="1:1" selected>â¬œ æ­£æ–¹å½¢ (1:1)</option>
            <option value="9:16">ğŸ“± ç¸¦é•· (9:16)</option>
          </select>
        </div>
      </div>
      
      <button class="generate-btn" onclick="generateImages()" id="generateBtn">
        ğŸš€ ç”»åƒã‚’ç”Ÿæˆã™ã‚‹
      </button>
    </div>

    <div class="results-section" id="resultsSection">
      <div id="loadingSection" class="loading hidden">
        <div class="loading-spinner"></div>
        <div id="loadingMessage">AIãŒæ–‡ç« ã‚’åˆ†å‰²ã—ã¦ã„ã¾ã™...</div>
        <div style="font-size: 14px; margin-top: 10px;">ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„</div>
      </div>
      
      <div id="imagesSection" class="hidden">
        <h2>ğŸ–¼ï¸ ç”Ÿæˆã•ã‚ŒãŸç”»åƒ</h2>
        <div id="imagesGrid" class="images-grid"></div>
      </div>
    </div>

    <div id="message"></div>
  </div>


  <script>
    const BACKEND = 'https://illustauto-backend-production.up.railway.app';
    let userEmail = '';

    // èªè¨¼ãƒã‚§ãƒƒã‚¯ï¼ˆç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ç¦æ­¢ï¼‰
    function checkAuth() {
      const token = localStorage.getItem('access_token');
      
      console.log('ğŸ” èªè¨¼ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œä¸­...');
      console.log('ğŸ”‘ ãƒˆãƒ¼ã‚¯ãƒ³çŠ¶æ³:', token ? 'å­˜åœ¨' : 'æœªä¿å­˜');
      
      if (!token) {
        console.log('âŒ èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ãªã— - login.htmlã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ');
        window.location.href = './login.html';
        return false;
      }
      
      console.log('âœ… èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ç¢ºèªæ¸ˆã¿');
      return true;
    }

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—
    async function getUserInfo() {
      const token = localStorage.getItem('access_token');
      console.log('ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—é–‹å§‹...');
      
      try {
        const xhr = new XMLHttpRequest();
        xhr.open('GET', `${BACKEND}/api/auth/me`, true);
        xhr.setRequestHeader('Authorization', `Bearer ${token}`);
        
        xhr.onload = function() {
          console.log('ğŸ“¡ ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹:', xhr.status, xhr.responseText);
          
          if (xhr.status === 200) {
            const data = JSON.parse(xhr.responseText);
            userEmail = data.user.email;
            document.getElementById('userInfo').textContent = `ğŸ‘¤ ${data.user.email}`;
            console.log('âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—æˆåŠŸ:', data.user.email);
          } else {
            console.log('âŒ èªè¨¼å¤±æ•— - ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå®Ÿè¡Œ');
            alert('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™');
            logout();
          }
        };
        
        xhr.onerror = function() {
          console.log('âŒ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ - ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå®Ÿè¡Œ');
          alert('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™');
          logout();
        };
        
        xhr.send();
      } catch (error) {
        console.log('âŒ ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼:', error);
        alert('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™');
        logout();
      }
    }

    // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
    function logout() {
      localStorage.removeItem('access_token');
      localStorage.removeItem('refresh_token');
      window.location.href = './login.html';
    }

    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
    function showMessage(text, type = 'info') {
      const messageDiv = document.getElementById('message');
      messageDiv.className = `message ${type}`;
      messageDiv.textContent = text;
      messageDiv.style.display = 'block';
      
      setTimeout(() => messageDiv.style.display = 'none', 5000);
    }

    // æ–‡å­—æ•°ã‚«ã‚¦ãƒ³ãƒˆ
    function updateCharCount() {
      const content = document.getElementById('content').value;
      document.getElementById('charCount').textContent = content.length;
    }

    // ç”»åƒç”Ÿæˆ
    async function generateImages() {
      const content = document.getElementById('content').value.trim();
      const style = document.getElementById('style').value;
      const aspectRatio = document.getElementById('aspectRatio').value;
      
      if (!content) {
        showMessage('è¨˜äº‹ã®å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
        return;
      }

      if (content.length > 5000) {
        showMessage('è¨˜äº‹ã®å†…å®¹ã¯5000æ–‡å­—ä»¥å†…ã«ã—ã¦ãã ã•ã„', 'error');
        return;
      }

      const generateBtn = document.getElementById('generateBtn');
      const loadingSection = document.getElementById('loadingSection');
      const imagesSection = document.getElementById('imagesSection');
      
      generateBtn.disabled = true;
      generateBtn.textContent = 'ç”Ÿæˆä¸­...';
      loadingSection.classList.remove('hidden');
      imagesSection.classList.add('hidden');
      
      // AIåˆ†å‰²ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã—ã¦ã‹ã‚‰ç”»åƒç”Ÿæˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«å¤‰æ›´
      const loadingMessage = document.getElementById('loadingMessage');
      loadingMessage.textContent = 'AIãŒæ–‡ç« ã‚’åˆ†å‰²ã—ã¦ã„ã¾ã™...';
      setTimeout(() => {
        loadingMessage.textContent = 'ç”»åƒã‚’ç”Ÿæˆã—ã¦ã„ã¾ã™...';
      }, 2000);

      try {
        const token = localStorage.getItem('access_token');
        const xhr = new XMLHttpRequest();
        xhr.open('POST', `${BACKEND}/api/generate`, true);
        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.setRequestHeader('Authorization', `Bearer ${token}`);
        
        xhr.onload = function() {
          generateBtn.disabled = false;
          generateBtn.textContent = 'ğŸš€ ç”»åƒã‚’ç”Ÿæˆã™ã‚‹';
          loadingSection.classList.add('hidden');
          
          if (xhr.status === 200) {
            const data = JSON.parse(xhr.responseText);
            if (data.images && data.images.length > 0) {
              displayImages(data.images);
              showMessage(`${data.images.length}æšã®ç”»åƒã‚’ç”Ÿæˆã—ã¾ã—ãŸï¼`, 'success');
            } else {
              showMessage('ç”»åƒã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
          } else if (xhr.status === 401) {
            logout();
          } else {
            const errorData = JSON.parse(xhr.responseText);
            showMessage(errorData.message || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
          }
        };
        
        xhr.onerror = function() {
          generateBtn.disabled = false;
          generateBtn.textContent = 'ğŸš€ ç”»åƒã‚’ç”Ÿæˆã™ã‚‹';
          loadingSection.classList.add('hidden');
          showMessage('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
        };
        
        xhr.send(JSON.stringify({
          content: content,
          taste: style,
          aspectRatio: aspectRatio
        }));
        
      } catch (error) {
        generateBtn.disabled = false;
        generateBtn.textContent = 'ğŸš€ ç”»åƒã‚’ç”Ÿæˆã™ã‚‹';
        loadingSection.classList.add('hidden');
        showMessage('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
      }
    }

    // ç”»åƒè¡¨ç¤º
    function displayImages(images) {
      const grid = document.getElementById('imagesGrid');
      const section = document.getElementById('imagesSection');
      
      // ç”»åƒé…åˆ—ã‚’ä¿å­˜ï¼ˆä¿®æ­£æ©Ÿèƒ½ã§ä½¿ç”¨ï¼‰
      originalImages = images;
      
      grid.innerHTML = '';
      
      images.forEach((image, index) => {
        const card = document.createElement('div');
        card.className = 'image-card';
        
        card.innerHTML = `
          <div class="image-container">
            <img src="${image.dataUrl}" alt="${image.title}" />
          </div>
          <div class="image-info">
            <div class="image-title">${image.title || `ç”»åƒ ${index + 1}`}</div>
            ${image.heading ? `<div style="font-size: 12px; color: #888; margin-bottom: 5px;">ğŸ“‘ ${image.heading}</div>` : ''}
            <div style="display: flex; gap: 10px; margin-top: 10px;">
              <button class="download-btn" onclick="downloadImage('${image.title || `ç”»åƒ_${index + 1}`}', '${image.dataUrl}')" style="flex: 1;">
                â¬‡ï¸ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
              </button>
              <button class="regenerate-btn" onclick="executeRegenerationDirect(${index})" style="flex: 1;">
                ğŸ”„ ä¿®æ­£
              </button>
            </div>
            <!-- ä¿®æ­£UIå¸¸æ™‚è¡¨ç¤º -->
            <div style="background: #f8f9fa; border: 1px solid #ddd; border-radius: 8px; padding: 10px; margin-top: 10px;">
              <div style="display: flex; gap: 10px;">
                <select id="regenerate-style-${index}" style="flex: 1; padding: 6px; border: 1px solid #ccc; border-radius: 4px;">
                  <option value="photo">å†™çœŸç”»è³ª</option>
                  <option value="deformed">ãƒ‡ãƒ•ã‚©ãƒ«ãƒ¡ã‚¢ãƒ‹ãƒ¡</option>
                  <option value="watercolor">æ‰‹æ›¸ãæ°´å½©ç”»</option>
                  <option value="detailed">ç²¾å¯†ã‚¤ãƒ©ã‚¹ãƒˆ</option>
                  <option value="pictogram">ãƒ”ã‚¯ãƒˆã‚°ãƒ©ãƒ </option>
                </select>
                <select id="regenerate-ratio-${index}" style="flex: 1; padding: 6px; border: 1px solid #ccc; border-radius: 4px;">
                  <option value="16:9">æ¨ªé•·</option>
                  <option value="1:1">æ­£æ–¹å½¢</option>
                  <option value="9:16">ç¸¦é•·</option>
                </select>
              </div>
            </div>
          </div>
        `;
        
        grid.appendChild(card);
      });
      
      section.classList.remove('hidden');
    }

    // ç”»åƒãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
    function downloadImage(title, dataUrl) {
      const a = document.createElement('a');
      a.href = dataUrl;
      
      // dataUrlã®å½¢å¼ã«å¿œã˜ã¦é©åˆ‡ãªæ‹¡å¼µå­ã‚’è¨­å®š
      let extension = '.png';
      if (dataUrl.startsWith('data:image/svg+xml')) {
        extension = '.svg';
      } else if (dataUrl.startsWith('data:image/jpeg')) {
        extension = '.jpg';
      } else if (dataUrl.startsWith('data:image/webp')) {
        extension = '.webp';
      }
      
      a.download = `illustauto_${title}${extension}`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }

    // ç”»åƒå†ç”Ÿæˆé–¢é€£
    let originalImages = [];

    // å†ç”Ÿæˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®è¡¨ç¤ºï¼ˆã‚¤ãƒ³ãƒ©ã‚¤ãƒ³è¡¨ç¤ºï¼‰
    function showRegenerateOptions(imageIndex) {
      if (imageIndex < 0 || !originalImages[imageIndex]) {
        showMessage('ä¿®æ­£å¯¾è±¡ã®ç”»åƒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
        return;
      }

      // æ—¢å­˜ã®ä¿®æ­£UIã‚’å‰Šé™¤
      const existingUI = document.querySelector('.regenerate-options-ui');
      if (existingUI) {
        existingUI.remove();
      }

      // ç”»åƒã‚«ãƒ¼ãƒ‰ã‚’ç‰¹å®š
      const imageCards = document.querySelectorAll('.image-container');
      const imageCard = imageCards[imageIndex];
      if (!imageCard) {
        showMessage('ç”»åƒè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
        return;
      }

      const currentStyle = document.getElementById('style').value;
      const currentAspectRatio = document.getElementById('aspectRatio').value;

      // ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ä¿®æ­£UIã‚’ä½œæˆ
      const regenerateUI = document.createElement('div');
      regenerateUI.className = 'regenerate-options-ui';
      regenerateUI.innerHTML = `
        <div style="background: #f8f9fa; border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin-top: 10px;">
          <h4 style="margin: 0 0 10px 0; color: #333;">ç”»åƒä¿®æ­£ã‚ªãƒ—ã‚·ãƒ§ãƒ³</h4>
          
          <div style="display: flex; gap: 15px; margin-bottom: 15px;">
            <div style="flex: 1;">
              <label style="display: block; margin-bottom: 5px; font-weight: bold;">ãƒ†ã‚¤ã‚¹ãƒˆ:</label>
              <select id="regenerate-style-${imageIndex}" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                <option value="photo" ${currentStyle === 'photo' ? 'selected' : ''}>å†™çœŸç”»è³ª</option>
                <option value="deformed" ${currentStyle === 'deformed' ? 'selected' : ''}>ãƒ‡ãƒ•ã‚©ãƒ«ãƒ¡ã‚¢ãƒ‹ãƒ¡</option>
                <option value="watercolor" ${currentStyle === 'watercolor' ? 'selected' : ''}>æ‰‹æ›¸ãæ°´å½©ç”»</option>
                <option value="detailed" ${currentStyle === 'detailed' ? 'selected' : ''}>ç²¾å¯†ã‚¤ãƒ©ã‚¹ãƒˆ</option>
                <option value="pictogram" ${currentStyle === 'pictogram' ? 'selected' : ''}>ãƒ”ã‚¯ãƒˆã‚°ãƒ©ãƒ </option>
              </select>
            </div>
            
            <div style="flex: 1;">
              <label style="display: block; margin-bottom: 5px; font-weight: bold;">ã‚µã‚¤ã‚º:</label>
              <select id="regenerate-ratio-${imageIndex}" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                <option value="16:9" ${currentAspectRatio === '16:9' ? 'selected' : ''}>æ¨ªé•· (16:9)</option>
                <option value="1:1" ${currentAspectRatio === '1:1' ? 'selected' : ''}>æ­£æ–¹å½¢ (1:1)</option>
                <option value="9:16" ${currentAspectRatio === '9:16' ? 'selected' : ''}>ç¸¦é•· (9:16)</option>
              </select>
            </div>
          </div>
          
          <div style="display: flex; gap: 10px;">
            <button onclick="executeRegeneration(${imageIndex})" style="flex: 1; padding: 10px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
              ğŸ”„ ä¿®æ­£å®Ÿè¡Œ
            </button>
            <button onclick="cancelRegeneration()" style="flex: 1; padding: 10px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">
              âœ–ï¸ ã‚­ãƒ£ãƒ³ã‚»ãƒ«
            </button>
          </div>
        </div>
      `;

      imageCard.appendChild(regenerateUI);
    }

    function executeRegeneration(imageIndex) {
      const styleSelect = document.getElementById(`regenerate-style-${imageIndex}`);
      const ratioSelect = document.getElementById(`regenerate-ratio-${imageIndex}`);
      
      if (!styleSelect || !ratioSelect) {
        showMessage('ä¿®æ­£ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
        return;
      }
      
      const selectedStyle = styleSelect.value;
      const selectedRatio = ratioSelect.value;
      
      // UIã‚’å‰Šé™¤
      cancelRegeneration();
      
      // å†ç”Ÿæˆå®Ÿè¡Œ
      autoRegenerateImage(imageIndex, selectedStyle, selectedRatio);
    }

    // ç›´æ¥å†ç”Ÿæˆï¼ˆå¸¸æ™‚è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹UIç”¨ï¼‰
    function executeRegenerationDirect(imageIndex) {
      const styleSelect = document.getElementById(`regenerate-style-${imageIndex}`);
      const ratioSelect = document.getElementById(`regenerate-ratio-${imageIndex}`);
      
      if (!styleSelect || !ratioSelect) {
        showMessage('ä¿®æ­£ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
        return;
      }
      
      const selectedStyle = styleSelect.value;
      const selectedRatio = ratioSelect.value;
      
      // ç›´æ¥å†ç”Ÿæˆå®Ÿè¡Œï¼ˆUIã¯å‰Šé™¤ã—ãªã„ï¼‰
      autoRegenerateImage(imageIndex, selectedStyle, selectedRatio);
    }

    function cancelRegeneration() {
      const existingUI = document.querySelector('.regenerate-options-ui');
      if (existingUI) {
        existingUI.remove();
      }
    }

    // è‡ªå‹•çš„ã«ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å°‘ã—ä¿®æ­£ã—ã¦å†ç”Ÿæˆ
    async function autoRegenerateImage(imageIndex, customStyle = null, customAspectRatio = null) {
      if (imageIndex < 0 || !originalImages[imageIndex]) {
        showMessage('ä¿®æ­£å¯¾è±¡ã®ç”»åƒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
        return;
      }

      const originalImage = originalImages[imageIndex];
      
      // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–ã—ã¦çŠ¶æ…‹è¡¨ç¤º
      const regenerateButtons = document.querySelectorAll('.regenerate-btn');
      const targetBtn = regenerateButtons[imageIndex];
      if (targetBtn) {
        targetBtn.disabled = true;
        targetBtn.textContent = 'ä¿®æ­£ä¸­...';
      }

      try {
        const token = localStorage.getItem('access_token');
        
        // è‡ªå‹•ä¿®æ­£æŒ‡ç¤ºã‚’ç”Ÿæˆï¼ˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å°‘ã—å¤‰æ›´ï¼‰
        const autoInstructions = generateAutoInstructions(originalImage.prompt);
        
        const xhr = new XMLHttpRequest();
        xhr.open('POST', `${BACKEND}/api/regenerate`, true);
        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.setRequestHeader('Authorization', `Bearer ${token}`);

        xhr.onload = function() {
          // ãƒœã‚¿ãƒ³çŠ¶æ…‹ã‚’å¾©å…ƒ
          if (targetBtn) {
            targetBtn.disabled = false;
            targetBtn.textContent = 'ğŸ”„ ä¿®æ­£';
          }

          if (xhr.status === 200) {
            const data = JSON.parse(xhr.responseText);
            if (data.success && data.image) {
              // å…ƒã®ç”»åƒã‚’ä¿®æ­£ç‰ˆã§ç½®ãæ›ãˆï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç½®æ›ï¼‰
              originalImages[imageIndex] = data.image;
              displayImages(originalImages);
              showMessage(`ç”»åƒ ${imageIndex + 1} ã‚’ä¿®æ­£ã—ã¾ã—ãŸï¼`, 'success');
            } else {
              showMessage(data.message || 'ä¿®æ­£ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
          } else if (xhr.status === 401) {
            logout();
          } else {
            const errorData = JSON.parse(xhr.responseText);
            showMessage(errorData.message || 'ä¿®æ­£ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
          }
        };

        xhr.onerror = function() {
          if (targetBtn) {
            targetBtn.disabled = false;
            targetBtn.textContent = 'ğŸ”„ ä¿®æ­£';
          }
          showMessage('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
        };

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼é¸æŠã¾ãŸã¯ãƒ•ã‚©ãƒ¼ãƒ ã®å€¤ã‚’ä½¿ç”¨
        xhr.send(JSON.stringify({
          originalPrompt: originalImage.prompt,
          instructions: autoInstructions,
          style: customStyle || document.getElementById('style').value,
          aspectRatio: customAspectRatio || document.getElementById('aspectRatio').value
        }));

      } catch (error) {
        if (targetBtn) {
          targetBtn.disabled = false;
          targetBtn.textContent = 'ğŸ”„ ä¿®æ­£';
        }
        showMessage('ä¿®æ­£ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
      }
    }

    // 30ç¨®é¡ä»¥ä¸Šã®è©³ç´°ãªãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆv1_backupã‹ã‚‰å¾©å…ƒï¼‰
    const VISUAL_VARIANTS = [
      {
        angle: "æ­£é¢ã‹ã‚‰è¦‹ä¸Šã’ã‚‹ãƒ­ãƒ¼ã‚¢ãƒ³ã‚°ãƒ«",
        shot: "å…¨èº«ã‚’æ‰ãˆãŸåºƒè§’ã‚·ãƒ§ãƒƒãƒˆ",
        lighting: "é€†å…‰ã§ã‚·ãƒ«ã‚¨ãƒƒãƒˆã‚’å¼·èª¿",
        mood: "åŠ›å¼·ã•ã¨æ±ºæ„ã‚’æ„Ÿã˜ã‚‹é›°å›²æ°—",
        environment: "éƒ½å¸‚ã®é«˜å±¤ãƒ“ãƒ«ç¾¤ã‚’èƒŒæ™¯ã«"
      },
      {
        angle: "çœŸä¸Šã‹ã‚‰è¦‹ä¸‹ã‚ã™ä¿¯ç°",
        shot: "å¯¾è±¡ã‚’ä¸­å¿ƒã«é…ç½®ã—ãŸæ§‹å›³",
        lighting: "å‡ç­‰ã«æ˜ã‚‹ã„æ˜¼å…‰",
        mood: "é™å¯‚ã§æ•´ç„¶ã¨ã—ãŸé›°å›²æ°—",
        environment: "é–‹ã‘ãŸåºƒå ´ã‚„å…¬åœ’"
      },
      {
        angle: "æ–œã‚45åº¦ã‹ã‚‰è¦‹ãŸè¦–ç‚¹",
        shot: "ä¸ŠåŠèº«ã‚’ã‚¯ãƒ­ãƒ¼ã‚ºã‚¢ãƒƒãƒ—",
        lighting: "æŸ”ã‚‰ã‹ã„è‡ªç„¶å…‰ãŒæ¨ªã‹ã‚‰",
        mood: "è¦ªã—ã¿ã‚„ã™ãæ¸©ã‹ã„é›°å›²æ°—",
        environment: "ã‚«ãƒ•ã‚§ã‚„ãƒªãƒ“ãƒ³ã‚°ãƒ«ãƒ¼ãƒ "
      },
      {
        angle: "æ¨ªã‹ã‚‰æ‰ãˆãŸãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«",
        shot: "äººç‰©ã®æ¨ªé¡”ã‚’ãƒ•ãƒ¬ãƒ¼ãƒ ã„ã£ã±ã„ã«",
        lighting: "çª“ã‹ã‚‰ã®å…‰ãŒãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’ä½œã‚‹",
        mood: "æ€ç´¢çš„ã§è½ã¡ç€ã„ãŸé›°å›²æ°—",
        environment: "æ›¸æ–ã‚„å›³æ›¸é¤¨"
      },
      {
        angle: "ã‚„ã‚„ä¸Šã‹ã‚‰è¦‹ä¸‹ã‚ã™è¦–ç‚¹",
        shot: "ãƒ†ãƒ¼ãƒ–ãƒ«ä¸Šã®ä½œæ¥­ã‚’æ‰ãˆã‚‹",
        lighting: "ãƒ‡ã‚¹ã‚¯ãƒ©ã‚¤ãƒˆã®æ¸©ã‹ã„å…‰",
        mood: "é›†ä¸­ã¨å‰µé€ æ€§ã‚’æ„Ÿã˜ã‚‹é›°å›²æ°—",
        environment: "ã‚ªãƒ•ã‚£ã‚¹ã‚„å·¥æˆ¿"
      },
      {
        angle: "åœ°é¢ã™ã‚Œã™ã‚Œã®è¶…ãƒ­ãƒ¼ã‚¢ãƒ³ã‚°ãƒ«",
        shot: "è¶³å…ƒã‹ã‚‰å…¨èº«ã‚’è¦‹ä¸Šã’ã‚‹æ§‹å›³",
        lighting: "å¼·ã„å½±ã‚’ä½œã‚‹å¤•æ—¥",
        mood: "ãƒ‰ãƒ©ãƒãƒãƒƒã‚¯ã§å°è±¡çš„ãªé›°å›²æ°—",
        environment: "å±‹å¤–ã®é–‹ã‘ãŸå ´æ‰€"
      },
      {
        angle: "é³¥ã®ç›®ç·šã®çœŸä¸Šã‹ã‚‰",
        shot: "è¤‡æ•°äººã‚’é…ç½®ã—ãŸãƒ‘ã‚¿ãƒ¼ãƒ³æ§‹å›³",
        lighting: "å‡ä¸€ãªç…§æ˜ã§å½±ã‚’æœ€å°é™ã«",
        mood: "å”èª¿æ€§ã¨ãƒãƒ©ãƒ³ã‚¹ã‚’æ„Ÿã˜ã‚‹é›°å›²æ°—",
        environment: "ä¼šè­°å®¤ã‚„ã‚¹ã‚¿ã‚¸ã‚ª"
      },
      {
        angle: "ç›®ç·šã®é«˜ã•ã§ã®æ­£é¢æ§‹å›³",
        shot: "é¡”ã‚’å¤§ããã‚¯ãƒ­ãƒ¼ã‚ºã‚¢ãƒƒãƒ—",
        lighting: "å‰æ–¹ã‹ã‚‰æŸ”ã‚‰ã‹ãç…§ã‚‰ã™",
        mood: "è¦ªå¯†ã§æ„Ÿæƒ…çš„ãªé›°å›²æ°—",
        environment: "å±‹å†…ã®è‡ªç„¶å…‰ãŒå…¥ã‚‹å ´æ‰€"
      },
      {
        angle: "ä¸‹ã‹ã‚‰è¦‹ä¸Šã’ã‚‹è¿«åŠ›ã‚ã‚‹æ§‹å›³",
        shot: "å»ºç‰©ã‚„ç‰©ä½“ã®å¨åœ§æ„Ÿã‚’å¼·èª¿",
        lighting: "å¤œé–“ã®äººå·¥ç…§æ˜",
        mood: "å¨å³ã¨åŠ›å¼·ã•ã‚’æ„Ÿã˜ã‚‹é›°å›²æ°—",
        environment: "éƒ½å¸‚ã®å¤œæ™¯"
      },
      {
        angle: "æ–œã‚å¾Œã‚ã‹ã‚‰ã®è¦–ç‚¹",
        shot: "èƒŒä¸­è¶Šã—ã«å‰æ–¹ã‚’è¦‹ã‚‹æ§‹å›³",
        lighting: "å‰æ–¹ã‹ã‚‰ã®é€†å…‰",
        mood: "å†’é™ºå¿ƒã¨æœŸå¾…ã‚’æ„Ÿã˜ã‚‹é›°å›²æ°—",
        environment: "è‡ªç„¶ã®ä¸­ã‚„è¡—ã®é€šã‚Š"
      },
      {
        angle: "çœŸæ¨ªã‹ã‚‰ã®å¹³é¢çš„ãªè¦–ç‚¹",
        shot: "å‹•ãã‚’æ‰ãˆãŸã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚·ãƒ§ãƒƒãƒˆ",
        lighting: "ã‚¹ãƒˆãƒ­ãƒœã§å‹•ãã‚’å‡çµ",
        mood: "ã‚¨ãƒãƒ«ã‚®ãƒƒã‚·ãƒ¥ã§å‹•çš„ãªé›°å›²æ°—",
        environment: "ã‚¹ãƒãƒ¼ãƒ„æ–½è¨­ã‚„å±‹å¤–"
      },
      {
        angle: "ã‚„ã‚„ä¸‹ã‹ã‚‰ç…½ã‚‹æ§‹å›³",
        shot: "å¯¾è±¡ã®å¨å³ã‚’å¼·èª¿ã™ã‚‹é…ç½®",
        lighting: "ä¸‹ã‹ã‚‰ã®ç…§æ˜ã§åŠ‡çš„ã«",
        mood: "æ ¼å¼ã¨æ¨©å¨ã‚’æ„Ÿã˜ã‚‹é›°å›²æ°—",
        environment: "å¤§ç†çŸ³ã®å»ºç‰©å†…éƒ¨"
      },
      {
        angle: "ä¸Šã‹ã‚‰è¦‹ä¸‹ã‚ã™ä¿¯ç°",
        shot: "ä½œæ¥­ä¸­ã®æ‰‹å…ƒã‚’ã‚¯ãƒ­ãƒ¼ã‚ºã‚¢ãƒƒãƒ—",
        lighting: "çœŸä¸Šã‹ã‚‰ã®æ˜ã‚‹ã„ç…§æ˜",
        mood: "ä¸å¯§ã§ç¹Šç´°ãªé›°å›²æ°—",
        environment: "ã‚­ãƒƒãƒãƒ³ã‚„ä½œæ¥­å°"
      },
      {
        angle: "é ãã‹ã‚‰æœ›é ã§æ‰ãˆã‚‹",
        shot: "äººç‰©ã‚’é¢¨æ™¯ã®ä¸€éƒ¨ã¨ã—ã¦",
        lighting: "è‡ªç„¶ãªæ˜¼å…‰",
        mood: "å­¤ç‹¬ã¨é™ã‘ã•ã‚’æ„Ÿã˜ã‚‹é›°å›²æ°—",
        environment: "åºƒå¤§ãªè‡ªç„¶ã®ä¸­"
      },
      {
        angle: "ç›®ç·šã‚ˆã‚Šå°‘ã—é«˜ã„ä½ç½®ã‹ã‚‰",
        shot: "ã‚°ãƒ«ãƒ¼ãƒ—å…¨ä½“ã‚’æ‰ãˆãŸæ§‹å›³",
        lighting: "æŸ”ã‚‰ã‹ãå‡ç­‰ãªç…§æ˜",
        mood: "èª¿å’Œã¨ä¸€ä½“æ„Ÿã‚’æ„Ÿã˜ã‚‹é›°å›²æ°—",
        environment: "é›†ä¼šæ‰€ã‚„åºƒã„å®¤å†…"
      },
      {
        angle: "æ–œã‚ä¸Šã‹ã‚‰è¦‹ä¸‹ã‚ã™è¦–ç‚¹",
        shot: "åº§ã£ã¦ã„ã‚‹äººç‰©ã‚’æ‰ãˆã‚‹",
        lighting: "çª“ã‹ã‚‰ã®è‡ªç„¶å…‰",
        mood: "ãƒªãƒ©ãƒƒã‚¯ã‚¹ã—ãŸç©ã‚„ã‹ãªé›°å›²æ°—",
        environment: "ãƒªãƒ“ãƒ³ã‚°ã‚„ã‚«ãƒ•ã‚§"
      },
      {
        angle: "æ¥µç«¯ãªãƒ¯ã‚¤ãƒ‰ã‚¢ãƒ³ã‚°ãƒ«",
        shot: "ç©ºé–“ã®åºƒãŒã‚Šã‚’å¼·èª¿",
        lighting: "æ˜æš—å·®ã®ã‚ã‚‹ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆ",
        mood: "é–‹æ”¾æ„Ÿã¨åºƒãŒã‚Šã‚’æ„Ÿã˜ã‚‹é›°å›²æ°—",
        environment: "å¤§ããªãƒ›ãƒ¼ãƒ«ã‚„å±‹å¤–"
      },
      {
        angle: "æ¥å†™ãƒã‚¯ãƒ­çš„ãªè¦–ç‚¹",
        shot: "ç´°éƒ¨ã‚’å¤§ããæ‰ãˆã‚‹",
        lighting: "ã‚½ãƒ•ãƒˆãƒœãƒƒã‚¯ã‚¹ã§å‡ä¸€ã«",
        mood: "ç²¾å¯†ã•ã¨æ³¨æ„æ·±ã•ã‚’æ„Ÿã˜ã‚‹é›°å›²æ°—",
        environment: "ã‚¹ã‚¿ã‚¸ã‚ªã‚„ç ”ç©¶å®¤"
      },
      {
        angle: "æ–œã‚ã‹ã‚‰æ‰ãˆãŸä¸‰ç‚¹é€è¦–",
        shot: "å»ºç‰©ã‚„ç©ºé–“ã®å¥¥è¡Œãã‚’å¼·èª¿",
        lighting: "å¤•æš®ã‚Œã®æ–œå…‰",
        mood: "ãƒ‰ãƒ©ãƒãƒãƒƒã‚¯ã§å°è±¡çš„ãªé›°å›²æ°—",
        environment: "éƒ½å¸‚ã®è¡—è§’"
      },
      {
        angle: "æ°´å¹³ç·šä¸Šã®ç›®ç·šã§",
        shot: "å¯¾ç§°çš„ãªæ§‹å›³",
        lighting: "å‡ç­‰ãªæ‹¡æ•£å…‰",
        mood: "ãƒãƒ©ãƒ³ã‚¹ã¨èª¿å’Œã‚’æ„Ÿã˜ã‚‹é›°å›²æ°—",
        environment: "ãƒ¢ãƒ€ãƒ³ãªå»ºç¯‰å†…éƒ¨"
      },
      {
        angle: "ã‚„ã‚„ä¸‹ã‹ã‚‰è¦‹ä¸Šã’ã‚‹æ§‹å›³",
        shot: "äººç‰©ã®è¡¨æƒ…ã‚’ã‚¯ãƒ­ãƒ¼ã‚ºã‚¢ãƒƒãƒ—",
        lighting: "å‰æ–¹ã‹ã‚‰ã®ã‚½ãƒ•ãƒˆãƒ©ã‚¤ãƒˆ",
        mood: "å¸Œæœ›ã¨å‰å‘ãã•ã‚’æ„Ÿã˜ã‚‹é›°å›²æ°—",
        environment: "æ˜ã‚‹ã„å®¤å†…"
      },
      {
        angle: "çœŸå¾Œã‚ã‹ã‚‰ã®è¦–ç‚¹",
        shot: "å¾Œã‚å§¿ã‚’æ‰ãˆãŸæ§‹å›³",
        lighting: "å‰æ–¹ã®æ˜ã‚‹ã„å…‰ã«å‘ã‹ã£ã¦",
        mood: "æ—…ç«‹ã¡ã¨æœŸå¾…ã‚’æ„Ÿã˜ã‚‹é›°å›²æ°—",
        environment: "é§…ã‚„ç©ºæ¸¯"
      },
      {
        angle: "æ–œã‚ä¸‹ã‹ã‚‰ç…½ã‚‹æ§‹å›³",
        shot: "å…¨èº«ã‚’åŠ›å¼·ãæ‰ãˆã‚‹",
        lighting: "ä¸‹ã‹ã‚‰ã®ã‚¢ãƒƒãƒ—ãƒ©ã‚¤ãƒˆ",
        mood: "ãƒ’ãƒ­ã‚¤ãƒƒã‚¯ã§å‹‡æ•¢ãªé›°å›²æ°—",
        environment: "èˆå°ã‚„æ¼”å£‡"
      },
      {
        angle: "ä¸Šã‹ã‚‰è¦‹ä¸‹ã‚ã™é«˜æ‰€è¦–ç‚¹",
        shot: "è¡—ä¸¦ã¿ã‚„é¢¨æ™¯ã‚’ä¸€æœ›",
        lighting: "æ™´å¤©ã®è‡ªç„¶å…‰",
        mood: "çˆ½å¿«æ„Ÿã¨é”æˆæ„Ÿã‚’æ„Ÿã˜ã‚‹é›°å›²æ°—",
        environment: "é«˜å±¤ãƒ“ãƒ«ã®å±‹ä¸Š"
      },
      {
        angle: "ç›®ç·šã‚ˆã‚Šä½ã„ä½ç½®ã‹ã‚‰",
        shot: "å­ä¾›ç›®ç·šã®æ§‹å›³",
        lighting: "æŸ”ã‚‰ã‹ã„è‡ªç„¶å…‰",
        mood: "ç„¡é‚ªæ°—ã§ç´”çœŸãªé›°å›²æ°—",
        environment: "å…¬åœ’ã‚„éŠã³å ´"
      },
      {
        angle: "æ­£é¢ã‚„ã‚„å³å¯„ã‚Šã®è¦–ç‚¹",
        shot: "å¯¾è©±ã‚·ãƒ¼ãƒ³ã‚’æ‰ãˆã‚‹",
        lighting: "ä¸‰ç‚¹ç…§æ˜ã§ç«‹ä½“çš„ã«",
        mood: "è¦ªå¯†ã§å¯¾è©±çš„ãªé›°å›²æ°—",
        environment: "ä¼šè­°å®¤ã‚„å¯¾é¢ã®å ´"
      },
      {
        angle: "é æ™¯ã‹ã‚‰åºƒè§’ã§æ‰ãˆã‚‹",
        shot: "äººç‰©ã¨ç’°å¢ƒã‚’ä¸€ä½“çš„ã«",
        lighting: "ã‚´ãƒ¼ãƒ«ãƒ‡ãƒ³ã‚¢ãƒ¯ãƒ¼ã®æš–è‰²å…‰",
        mood: "ãƒã‚¹ã‚¿ãƒ«ã‚¸ãƒƒã‚¯ã§æƒ…ç·’çš„ãªé›°å›²æ°—",
        environment: "ç”°åœ’ã‚„æµ·è¾º"
      },
      {
        angle: "æ¨ªã‹ã‚‰æ‰ãˆãŸå‹•çš„æ§‹å›³",
        shot: "èµ°ã‚‹å§¿ã‚’æµã—æ’®ã‚Šé¢¨ã«",
        lighting: "é€†å…‰æ°—å‘³ã®ã‚¨ãƒƒã‚¸ãƒ©ã‚¤ãƒˆ",
        mood: "ã‚¹ãƒ”ãƒ¼ãƒ‰æ„Ÿã¨èºå‹•ã‚’æ„Ÿã˜ã‚‹é›°å›²æ°—",
        environment: "é“è·¯ã‚„ãƒˆãƒ©ãƒƒã‚¯"
      },
      {
        angle: "æ–œã‚ä¸Šã‹ã‚‰ã®é³¥ç°",
        shot: "è¤‡é›‘ãªé…ç½®ã‚’æ•´ç†ã—ã¦è¦‹ã›ã‚‹",
        lighting: "æ˜ã‚‹ãå‡ä¸€ãªç…§æ˜",
        mood: "æ•´ç„¶ã¨ã—ãŸç§©åºã‚’æ„Ÿã˜ã‚‹é›°å›²æ°—",
        environment: "å·¥å ´ã‚„å€‰åº«"
      },
      {
        angle: "æ¥µç«¯ãªãƒ­ãƒ¼ã‚¢ãƒ³ã‚°ãƒ«ã‹ã‚‰",
        shot: "ç©ºã¨å¯¾è±¡ã‚’å¯¾æ¯”ã•ã›ã‚‹æ§‹å›³",
        lighting: "é€†å…‰ã§ã‚·ãƒ«ã‚¨ãƒƒãƒˆåŒ–",
        mood: "å£®å¤§ã•ã¨è‡ªç”±ã‚’æ„Ÿã˜ã‚‹é›°å›²æ°—",
        environment: "é–‹ã‘ãŸé‡å¤–"
      }
    ];

    let usedVariantIndices = [];
    
    function resetUsedVariants() {
      usedVariantIndices = [];
    }
    
    function getUniqueVariant() {
      if (usedVariantIndices.length >= VISUAL_VARIANTS.length) {
        resetUsedVariants();
      }
      
      let attempts = 0;
      let index;
      
      do {
        index = Math.floor(Math.random() * VISUAL_VARIANTS.length);
        attempts++;
      } while (usedVariantIndices.includes(index) && attempts < 50);
      
      usedVariantIndices.push(index);
      return VISUAL_VARIANTS[index];
    }

    // è‡ªå‹•ä¿®æ­£æŒ‡ç¤ºã‚’ç”Ÿæˆ
    function generateAutoInstructions(originalPrompt) {
      const variant = getUniqueVariant();
      
      return `${variant.angle}ã§ã€${variant.shot}ã€‚${variant.lighting}ã‚’ä½¿ã„ã€${variant.mood}ã§ã€${variant.environment}ã®è¨­å®šã§ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚`;
    }

    // åˆæœŸåŒ–
    document.addEventListener('DOMContentLoaded', function() {
      console.log('ğŸ¯ app.htmlèª­ã¿è¾¼ã¿é–‹å§‹ï¼ˆåŒä¸€ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰ï¼‰');
      
      // æœ€åˆã«èªè¨¼ãƒã‚§ãƒƒã‚¯
      if (!checkAuth()) {
        console.log('âŒ èªè¨¼å¤±æ•— - åˆæœŸåŒ–ä¸­æ­¢');
        return;
      }
      
      console.log('âœ… èªè¨¼ãƒã‚§ãƒƒã‚¯é€šé - ã‚¢ãƒ—ãƒªåˆæœŸåŒ–é–‹å§‹');
      getUserInfo();
      
      // æ–‡å­—æ•°ã‚«ã‚¦ãƒ³ãƒˆ
      document.getElementById('content').addEventListener('input', updateCharCount);
      
      // Enterã‚­ãƒ¼ã§ã®ç”Ÿæˆé˜²æ­¢
      document.getElementById('content').addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
          generateImages();
        }
      });
    });
  </script>
</body>
</html>


<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IllustAuto - AI画像生成サービス</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      color: #333;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      padding: 40px;
    }
    
    .auth-container {
      max-width: 450px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      padding: 40px;
      text-align: center;
    }
    
    .logo {
      font-size: 48px;
      margin-bottom: 10px;
    }
    
    h1, h2 {
      color: #667eea;
      margin-bottom: 10px;
    }
    
    .subtitle {
      color: #666;
      margin-bottom: 30px;
      font-size: 14px;
    }
    
    .auth-form {
      margin-bottom: 25px;
    }
    
    .input-group {
      margin-bottom: 20px;
      text-align: left;
    }
    
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #333;
    }
    
    .auth-input {
      width: 100%;
      padding: 15px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 15px;
      transition: border-color 0.3s;
    }
    
    .auth-input:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .code-input {
      font-family: 'Courier New', monospace;
      font-size: 18px;
      letter-spacing: 3px;
      text-align: center;
    }
    
    .auth-button {
      width: 100%;
      padding: 15px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      margin-bottom: 15px;
    }
    
    .auth-button:hover:not(:disabled) {
      background: #5a6fd8;
      transform: translateY(-2px);
    }
    
    .auth-button:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }
    
    .auth-button.secondary {
      background: #f8f9fa;
      color: #667eea;
      border: 2px solid #667eea;
    }
    
    .auth-button.secondary:hover:not(:disabled) {
      background: #667eea;
      color: white;
    }
    
    .auth-status {
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 20px;
      font-weight: 500;
      display: none;
    }
    
    .auth-status.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .auth-status.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    .auth-status.info {
      background: #cce7ff;
      color: #004085;
      border: 1px solid #b8daff;
    }
    
    .demo-section {
      background: #f8f9fa;
      border: 2px solid #e9ecef;
      border-radius: 15px;
      padding: 30px;
      margin-bottom: 30px;
    }
    
    .demo-title {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 20px;
      font-size: 18px;
      font-weight: 600;
    }
    
    .divider {
      display: flex;
      align-items: center;
      text-align: center;
      margin: 30px 0;
      color: #666;
    }
    
    .divider::before,
    .divider::after {
      content: '';
      flex: 1;
      height: 1px;
      background: #ddd;
    }
    
    .divider span {
      padding: 0 20px;
      font-size: 14px;
    }
    
    .user-info {
      background: #f8f9fa;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 30px;
      text-align: left;
    }
    
    .user-email {
      font-weight: 600;
      color: #667eea;
    }
    
    .logout-btn {
      background: #dc3545;
      font-size: 14px;
      padding: 8px 15px;
    }
    
    .logout-btn:hover {
      background: #c82333;
    }
    
    .hidden {
      display: none !important;
    }
    
    .countdown {
      font-size: 14px;
      color: #666;
      margin-top: 10px;
    }
    
    .resend-section {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid #e0e0e0;
    }
    
    .images-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 30px;
    }
    
    .image-card {
      background: white;
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .image-card img {
      width: 100%;
      border-radius: 10px;
      margin-bottom: 15px;
    }
    
    .image-title {
      font-weight: 600;
      margin-bottom: 10px;
    }
    
    .status {
      padding: 15px;
      border-radius: 10px;
      margin: 20px 0;
      font-weight: 500;
    }
    
    .status.success { background: #d4edda; color: #155724; }
    .status.error { background: #f8d7da; color: #721c24; }
    .status.info { background: #cce7ff; color: #004085; }
    
    textarea {
      width: 100%;
      min-height: 120px;
      padding: 15px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 14px;
      font-family: inherit;
      resize: vertical;
    }
    
    select {
      width: 100%;
      padding: 15px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 14px;
      background: white;
    }
    
    .input-group label {
      font-size: 14px;
      margin-bottom: 8px;
    }
    
    @media (max-width: 768px) {
      .container, .auth-container {
        margin: 10px;
        padding: 20px;
      }
      
      body {
        padding: 10px;
      }
    }
  </style>
</head>
<body>
  <!-- 認証画面 -->
  <div id="authScreen" class="auth-container">
    <div class="logo">🎨</div>
    <h2>IllustAuto</h2>
    <p class="subtitle">AI画像生成サービス</p>
    
    <div id="authStatus" class="auth-status"></div>
    
    <!-- メール入力フォーム -->
    <div id="emailForm" class="auth-form">
      <div class="input-group">
        <label for="emailInput">📧 メールアドレス</label>
        <input type="email" id="emailInput" class="auth-input" placeholder="your@email.com" required>
      </div>
      <button id="sendCodeBtn" class="auth-button">🔑 認証コードを送信</button>
    </div>
    
    <!-- 認証コード入力フォーム -->
    <div id="codeForm" class="auth-form hidden">
      <div class="input-group">
        <label for="codeInput">🔢 認証コード（6桁）</label>
        <input type="text" id="codeInput" class="auth-input code-input" placeholder="123456" maxlength="6" required>
        <div id="countdown" class="countdown"></div>
      </div>
      <button id="verifyCodeBtn" class="auth-button">✅ ログイン</button>
      
      <div class="resend-section">
        <button id="resendCodeBtn" class="auth-button secondary" disabled>🔄 コードを再送信</button>
      </div>
      
      <button id="backToEmailBtn" class="auth-button secondary">← メールアドレスに戻る</button>
    </div>
    
    <!-- デモセクション -->
    <div class="divider">
      <span>または</span>
    </div>
    
    <div class="demo-section">
      <div class="demo-title">
        <span>🚀</span>
        <span>無料デモ（3回まで）</span>
      </div>
      <button id="tryDemoBtn" class="auth-button secondary">デモを試す</button>
    </div>
  </div>

  <!-- デモアプリ -->
  <div id="demoApp" class="container hidden">
    <div style="text-align: center; margin-bottom: 30px;">
      <h1>🎨 IllustAuto デモ</h1>
      <p style="color: #666;">AI画像生成を無料でお試しください（3回まで）</p>
    </div>
    
    <div class="input-group">
      <label for="demoContent">📝 記事内容（500文字以内）</label>
      <textarea id="demoContent" placeholder="ブログ記事の内容を入力してください..."></textarea>
    </div>
    
    <div class="input-group">
      <label for="demoSizeSelect">📐 画像サイズ</label>
      <select id="demoSizeSelect">
        <option value="1:1">1:1 スクエア</option>
        <option value="9:16">9:16 縦長</option>
        <option value="16:9">16:9 横長</option>
      </select>
    </div>
    
    <button id="demoGenerateBtn" class="auth-button">🚀 デモ生成</button>
    <button id="backToAuthBtn" class="auth-button secondary">← ログインに戻る</button>
    
    <div id="demoStatus" class="status" style="display: none;"></div>
    <div id="demoResults" class="images-grid"></div>
    
    <div style="text-align: center; margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 10px;">
      <p style="margin-bottom: 15px;">🔥 無制限でご利用いただくには</p>
      <button id="upgradeBtn" class="auth-button">無料登録する</button>
    </div>
  </div>

  <!-- メインアプリ -->
  <div id="mainApp" class="container hidden">
    <!-- ユーザー情報 -->
    <div id="userInfo" class="user-info">
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
          <div>ようこそ、<span id="userEmail" class="user-email"></span></div>
          <div style="font-size: 12px; color: #666; margin-top: 5px;">
            <span id="userRole"></span> | 最終ログイン: <span id="lastLogin"></span>
          </div>
        </div>
        <button id="logoutBtn" class="auth-button logout-btn">ログアウト</button>
      </div>
    </div>
    
    <!-- 使用量表示 -->
    <div id="usageInfo" style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 30px;">
      <h3 style="margin-bottom: 15px;">📊 本日の使用量</h3>
      <div style="margin-bottom: 10px;">
        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
          <span>記事処理</span>
          <span id="articleUsageText">0/5</span>
        </div>
        <div style="background: #e9ecef; height: 8px; border-radius: 4px;">
          <div id="articleUsageBar" style="background: #667eea; height: 100%; border-radius: 4px; width: 0%;"></div>
        </div>
      </div>
      <div>
        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
          <span>再生成</span>
          <span id="regenerationUsageText">0/50</span>
        </div>
        <div style="background: #e9ecef; height: 8px; border-radius: 4px;">
          <div id="regenerationUsageBar" style="background: #28a745; height: 100%; border-radius: 4px; width: 0%;"></div>
        </div>
      </div>
    </div>
    
    <!-- 画像生成フォーム -->
    <div class="input-group">
      <label for="content">📝 ブログ記事の内容</label>
      <textarea id="content" placeholder="ブログ記事の本文を入力してください..."></textarea>
    </div>
    
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
      <div class="input-group">
        <label for="tasteSelect">🎨 テイスト</label>
        <select id="tasteSelect">
          <option value="modern">モダン</option>
          <option value="classic">クラシック</option>
          <option value="minimal">ミニマル</option>
          <option value="colorful">カラフル</option>
        </select>
      </div>
      
      <div class="input-group">
        <label for="sizeSelect">📐 サイズ</label>
        <select id="sizeSelect">
          <option value="1:1">1:1 スクエア</option>
          <option value="9:16">9:16 縦長</option>
          <option value="16:9">16:9 横長</option>
        </select>
      </div>
    </div>
    
    <button id="generateBtn" class="auth-button">🚀 画像生成</button>
    
    <div id="status" class="status" style="display: none;"></div>
    <div id="imagesGrid" class="images-grid"></div>
  </div>

  <script>
    const BACKEND = "https://your-actual-railway-url.up.railway.app";
    
    // ========================================
    // グローバル変数
    // ========================================
    
    let currentUser = null;
    let accessToken = null;
    let refreshToken = null;
    let countdownInterval = null;
    
    // DOM要素
    const $authScreen = document.getElementById("authScreen");
    const $demoApp = document.getElementById("demoApp");
    const $mainApp = document.getElementById("mainApp");
    const $authStatus = document.getElementById("authStatus");
    
    // 認証フォーム
    const $emailForm = document.getElementById("emailForm");
    const $codeForm = document.getElementById("codeForm");
    const $emailInput = document.getElementById("emailInput");
    const $codeInput = document.getElementById("codeInput");
    const $sendCodeBtn = document.getElementById("sendCodeBtn");
    const $verifyCodeBtn = document.getElementById("verifyCodeBtn");
    const $resendCodeBtn = document.getElementById("resendCodeBtn");
    const $backToEmailBtn = document.getElementById("backToEmailBtn");
    const $countdown = document.getElementById("countdown");
    
    // デモ
    const $tryDemoBtn = document.getElementById("tryDemoBtn");
    const $demoContent = document.getElementById("demoContent");
    const $demoSizeSelect = document.getElementById("demoSizeSelect");
    const $demoGenerateBtn = document.getElementById("demoGenerateBtn");
    const $backToAuthBtn = document.getElementById("backToAuthBtn");
    const $upgradeBtn = document.getElementById("upgradeBtn");
    const $demoStatus = document.getElementById("demoStatus");
    const $demoResults = document.getElementById("demoResults");
    
    // メインアプリ
    const $userInfo = document.getElementById("userInfo");
    const $userEmail = document.getElementById("userEmail");
    const $userRole = document.getElementById("userRole");
    const $lastLogin = document.getElementById("lastLogin");
    const $logoutBtn = document.getElementById("logoutBtn");
    const $usageInfo = document.getElementById("usageInfo");
    const $articleUsageText = document.getElementById("articleUsageText");
    const $articleUsageBar = document.getElementById("articleUsageBar");
    const $regenerationUsageText = document.getElementById("regenerationUsageText");
    const $regenerationUsageBar = document.getElementById("regenerationUsageBar");
    const $content = document.getElementById("content");
    const $tasteSelect = document.getElementById("tasteSelect");
    const $sizeSelect = document.getElementById("sizeSelect");
    const $generateBtn = document.getElementById("generateBtn");
    const $status = document.getElementById("status");
    const $imagesGrid = document.getElementById("imagesGrid");
    
    // ========================================
    // ユーティリティ関数
    // ========================================
    
    function showAuthStatus(message, type = 'info') {
      $authStatus.textContent = message;
      $authStatus.className = `auth-status ${type}`;
      $authStatus.style.display = 'block';
      
      if (type !== 'error') {
        setTimeout(() => {
          $authStatus.style.display = 'none';
        }, 5000);
      }
    }
    
    function hideAuthStatus() {
      $authStatus.style.display = 'none';
    }
    
    function showStatus(element, message, type = 'info') {
      element.textContent = message;
      element.className = `status ${type}`;
      element.style.display = 'block';
    }
    
    function hideStatus(element) {
      element.style.display = 'none';
    }
    
    // ========================================
    // 認証関数
    // ========================================
    
    async function sendAuthCode() {
      const email = $emailInput.value.trim();
      
      if (!email) {
        showAuthStatus('メールアドレスを入力してください', 'error');
        return;
      }
      
      if (!isValidEmail(email)) {
        showAuthStatus('有効なメールアドレスを入力してください', 'error');
        return;
      }
      
      $sendCodeBtn.disabled = true;
      $sendCodeBtn.textContent = '送信中...';
      
      try {
        const response = await fetch(`${BACKEND}/api/auth/request-code`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email })
        });
        
        const data = await response.json();
        
        if (response.ok && data.success) {
          showAuthStatus('認証コードを送信しました！メールをご確認ください', 'success');
          showCodeForm();
          startCountdown(5 * 60); // 5分
        } else {
          throw new Error(data.message || '認証コードの送信に失敗しました');
        }
      } catch (error) {
        console.error('Send code error:', error);
        showAuthStatus(error.message, 'error');
      } finally {
        $sendCodeBtn.disabled = false;
        $sendCodeBtn.textContent = '🔑 認証コードを送信';
      }
    }
    
    async function verifyCode() {
      const email = $emailInput.value.trim();
      const code = $codeInput.value.trim();
      
      if (!email || !code) {
        showAuthStatus('メールアドレスと認証コードを入力してください', 'error');
        return;
      }
      
      if (!/^\d{6}$/.test(code)) {
        showAuthStatus('認証コードは6桁の数字で入力してください', 'error');
        return;
      }
      
      $verifyCodeBtn.disabled = true;
      $verifyCodeBtn.textContent = '認証中...';
      
      try {
        const response = await fetch(`${BACKEND}/api/auth/verify-code`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, code })
        });
        
        const data = await response.json();
        
        if (response.ok && data.success) {
          // ログイン成功
          currentUser = data.user;
          accessToken = data.accessToken;
          refreshToken = data.refreshToken;
          
          // トークンを保存
          localStorage.setItem('illustauto_access_token', accessToken);
          localStorage.setItem('illustauto_refresh_token', refreshToken);
          localStorage.setItem('illustauto_user', JSON.stringify(currentUser));
          
          showAuthStatus('ログインに成功しました！', 'success');
          
          setTimeout(() => {
            showMainApp();
          }, 1000);
        } else {
          throw new Error(data.message || '認証に失敗しました');
        }
      } catch (error) {
        console.error('Verify code error:', error);
        showAuthStatus(error.message, 'error');
      } finally {
        $verifyCodeBtn.disabled = false;
        $verifyCodeBtn.textContent = '✅ ログイン';
      }
    }
    
    async function logout() {
      try {
        if (accessToken) {
          await fetch(`${BACKEND}/api/auth/logout`, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${accessToken}` }
          });
        }
      } catch (error) {
        console.error('Logout error:', error);
      }
      
      // ローカル状態をクリア
      currentUser = null;
      accessToken = null;
      refreshToken = null;
      localStorage.removeItem('illustauto_access_token');
      localStorage.removeItem('illustauto_refresh_token');
      localStorage.removeItem('illustauto_user');
      
      showAuthScreen();
    }
    
    // ========================================
    // UI制御関数
    // ========================================
    
    function showAuthScreen() {
      $authScreen.classList.remove('hidden');
      $demoApp.classList.add('hidden');
      $mainApp.classList.add('hidden');
      
      // フォームをリセット
      showEmailForm();
      hideAuthStatus();
    }
    
    function showDemoApp() {
      $authScreen.classList.add('hidden');
      $demoApp.classList.remove('hidden');
      $mainApp.classList.add('hidden');
    }
    
    function showMainApp() {
      $authScreen.classList.add('hidden');
      $demoApp.classList.add('hidden');
      $mainApp.classList.remove('hidden');
      
      if (currentUser) {
        $userEmail.textContent = currentUser.email;
        $userRole.textContent = currentUser.role === 'developer' ? '開発者' : 'ユーザー';
        $lastLogin.textContent = new Date().toLocaleString('ja-JP');
        loadUsageStats();
      }
    }
    
    function showEmailForm() {
      $emailForm.classList.remove('hidden');
      $codeForm.classList.add('hidden');
      $emailInput.value = '';
      clearCountdown();
    }
    
    function showCodeForm() {
      $emailForm.classList.add('hidden');
      $codeForm.classList.remove('hidden');
      $codeInput.value = '';
      $codeInput.focus();
      
      // 再送信ボタンを無効化（60秒後に有効化）
      $resendCodeBtn.disabled = true;
      setTimeout(() => {
        $resendCodeBtn.disabled = false;
      }, 60000);
    }
    
    function startCountdown(seconds) {
      clearCountdown();
      
      const updateCountdown = () => {
        if (seconds <= 0) {
          $countdown.textContent = 'コードが期限切れです。再送信してください。';
          $countdown.style.color = '#dc3545';
          clearCountdown();
          return;
        }
        
        const minutes = Math.floor(seconds / 60);
        const remainingSeconds = seconds % 60;
        $countdown.textContent = `コード有効期限: ${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
        $countdown.style.color = '#666';
        seconds--;
      };
      
      updateCountdown();
      countdownInterval = setInterval(updateCountdown, 1000);
    }
    
    function clearCountdown() {
      if (countdownInterval) {
        clearInterval(countdownInterval);
        countdownInterval = null;
      }
      $countdown.textContent = '';
    }
    
    // ========================================
    // API関数
    // ========================================
    
    async function apiCall(endpoint, options = {}) {
      const url = `${BACKEND}${endpoint}`;
      const headers = {
        'Content-Type': 'application/json',
        ...options.headers
      };
      
      if (accessToken) {
        headers['Authorization'] = `Bearer ${accessToken}`;
      }
      
      try {
        const response = await fetch(url, {
          ...options,
          headers
        });
        
        if (response.status === 401) {
          // トークンが無効の場合、リフレッシュを試行
          if (refreshToken) {
            const refreshed = await refreshAccessToken();
            if (refreshed) {
              // リフレッシュ成功、リクエストを再試行
              headers['Authorization'] = `Bearer ${accessToken}`;
              return await fetch(url, { ...options, headers });
            }
          }
          
          // リフレッシュに失敗、ログアウト
          logout();
          throw new Error('認証の有効期限が切れました');
        }
        
        return response;
      } catch (error) {
        throw error;
      }
    }
    
    async function refreshAccessToken() {
      try {
        const response = await fetch(`${BACKEND}/api/auth/refresh`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ refreshToken })
        });
        
        const data = await response.json();
        
        if (response.ok && data.success) {
          accessToken = data.accessToken;
          localStorage.setItem('illustauto_access_token', accessToken);
          return true;
        }
        
        return false;
      } catch (error) {
        console.error('Token refresh error:', error);
        return false;
      }
    }
    
    async function loadUsageStats() {
      try {
        const response = await apiCall('/api/usage/stats');
        const data = await response.json();
        
        if (response.ok && data.success) {
          updateUsageDisplay(data.usage, data.limits);
        }
      } catch (error) {
        console.error('Usage stats error:', error);
      }
    }
    
    function updateUsageDisplay(usage, limits) {
      // 記事処理
      const articlePercent = limits.articles === -1 ? 0 : (usage.articleCount / limits.articles) * 100;
      $articleUsageText.textContent = limits.articles === -1 ? 
        `${usage.articleCount}/無制限` : 
        `${usage.articleCount}/${limits.articles}`;
      $articleUsageBar.style.width = `${Math.min(articlePercent, 100)}%`;
      
      // 再生成
      const regenPercent = limits.regenerations === -1 ? 0 : (usage.regenerationCount / limits.regenerations) * 100;
      $regenerationUsageText.textContent = limits.regenerations === -1 ? 
        `${usage.regenerationCount}/無制限` : 
        `${usage.regenerationCount}/${limits.regenerations}`;
      $regenerationUsageBar.style.width = `${Math.min(regenPercent, 100)}%`;
    }
    
    // ========================================
    // デモ機能
    // ========================================
    
    async function generateDemo() {
      const content = $demoContent.value.trim();
      
      if (!content) {
        showStatus($demoStatus, '記事内容を入力してください', 'error');
        return;
      }
      
      if (content.length > 500) {
        showStatus($demoStatus, 'デモ版では500文字以内で入力してください', 'error');
        return;
      }
      
      $demoGenerateBtn.disabled = true;
      $demoGenerateBtn.textContent = '生成中...';
      showStatus($demoStatus, '画像を生成しています...', 'info');
      
      try {
        const response = await fetch(`${BACKEND}/api/demo/generate`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            prompt: content,
            aspectRatio: $demoSizeSelect.value
          })
        });
        
        const data = await response.json();
        
        if (response.ok && data.success) {
          showStatus($demoStatus, '✅ デモ画像を生成しました！', 'success');
          
          $demoResults.innerHTML = `
            <div class="image-card">
              <img src="${data.dataUrl}" alt="Generated demo image">
              <div class="image-title">デモ生成画像</div>
              <p style="font-size: 14px; color: #666;">${data.demoInfo.message}</p>
            </div>
          `;
        } else {
          throw new Error(data.message || 'デモ画像の生成に失敗しました');
        }
      } catch (error) {
        console.error('Demo generation error:', error);
        showStatus($demoStatus, `❌ エラー: ${error.message}`, 'error');
      } finally {
        $demoGenerateBtn.disabled = false;
        $demoGenerateBtn.textContent = '🚀 デモ生成';
      }
    }
    
    // ========================================
    // メイン画像生成
    // ========================================
    
    async function generateImages() {
      const content = $content.value.trim();
      
      if (!content) {
        showStatus($status, 'ブログ記事の内容を入力してください', 'error');
        return;
      }
      
      $generateBtn.disabled = true;
      $generateBtn.textContent = '生成中...';
      showStatus($status, '画像を生成しています...', 'info');
      
      try {
        const response = await apiCall('/api/generate', {
          method: 'POST',
          body: JSON.stringify({
            content,
            taste: $tasteSelect.value,
            aspectRatio: $sizeSelect.value
          })
        });
        
        const data = await response.json();
        
        if (response.ok && data.success) {
          showStatus($status, '✅ 画像生成が完了しました！', 'success');
          
          $imagesGrid.innerHTML = data.images.map(img => `
            <div class="image-card">
              <img src="${img.dataUrl}" alt="${img.title}">
              <div class="image-title">${img.title}</div>
            </div>
          `).join('');
          
          // 使用量を更新
          if (data.usage) {
            updateUsageDisplay(data.usage, { articles: 5, regenerations: 50 });
          }
        } else {
          throw new Error(data.message || '画像生成に失敗しました');
        }
      } catch (error) {
        console.error('Image generation error:', error);
        showStatus($status, `❌ エラー: ${error.message}`, 'error');
      } finally {
        $generateBtn.disabled = false;
        $generateBtn.textContent = '🚀 画像生成';
      }
    }
    
    // ========================================
    // ユーティリティ
    // ========================================
    
    function isValidEmail(email) {
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return emailRegex.test(email);
    }
    
    // ========================================
    // イベントリスナー
    // ========================================
    
    // 認証フォーム
    $sendCodeBtn.addEventListener('click', sendAuthCode);
    $verifyCodeBtn.addEventListener('click', verifyCode);
    $resendCodeBtn.addEventListener('click', sendAuthCode);
    $backToEmailBtn.addEventListener('click', showEmailForm);
    
    // Enter キー対応
    $emailInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendAuthCode();
    });
    
    $codeInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') verifyCode();
    });
    
    // 数字のみ入力許可
    $codeInput.addEventListener('input', (e) => {
      e.target.value = e.target.value.replace(/\D/g, '');
    });
    
    // デモ
    $tryDemoBtn.addEventListener('click', showDemoApp);
    $demoGenerateBtn.addEventListener('click', generateDemo);
    $backToAuthBtn.addEventListener('click', showAuthScreen);
    $upgradeBtn.addEventListener('click', showAuthScreen);
    
    // メインアプリ
    $logoutBtn.addEventListener('click', logout);
    $generateBtn.addEventListener('click', generateImages);
    
    // ========================================
    // 初期化
    // ========================================
    
    async function checkExistingAuth() {
      const savedAccessToken = localStorage.getItem('illustauto_access_token');
      const savedRefreshToken = localStorage.getItem('illustauto_refresh_token');
      const savedUser = localStorage.getItem('illustauto_user');
      
      if (!savedAccessToken || !savedUser) {
        showAuthScreen();
        return;
      }
      
      try {
        accessToken = savedAccessToken;
        refreshToken = savedRefreshToken;
        currentUser = JSON.parse(savedUser);
        
        // トークンが有効かチェック
        const response = await apiCall('/api/auth/me');
        const data = await response.json();
        
        if (response.ok && data.success) {
          currentUser = data.user;
          showMainApp();
        } else {
          throw new Error('Invalid token');
        }
      } catch (error) {
        console.error('Auth check error:', error);
        logout();
      }
    }
    
    // アプリ初期化
    document.addEventListener('DOMContentLoaded', () => {
      checkExistingAuth();
    });
  </script>
</body>
</html>

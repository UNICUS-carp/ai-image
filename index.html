
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IllustAuto - ãƒ¡ãƒ¼ãƒ«èªè¨¼</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
            max-width: 500px;
            width: 100%;
            text-align: center;
        }
        
        .logo { font-size: 48px; margin-bottom: 10px; }
        h1 { color: #667eea; margin-bottom: 10px; }
        .subtitle { color: #666; margin-bottom: 30px; font-size: 14px; }
        
        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        
        input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 15px;
            transition: border-color 0.3s;
        }
        
        input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .code-input {
            font-family: 'Courier New', monospace;
            font-size: 18px;
            letter-spacing: 3px;
            text-align: center;
        }
        
        button {
            width: 100%;
            padding: 15px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 15px;
        }
        
        button:hover:not(:disabled) {
            background: #5a6fd8;
            transform: translateY(-2px);
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .secondary {
            background: #f8f9fa;
            color: #667eea;
            border: 2px solid #667eea !important;
        }
        
        .secondary:hover:not(:disabled) {
            background: #667eea;
            color: white;
        }
        
        .status {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-weight: 500;
            display: none;
        }
        
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #cce7ff; color: #004085; border: 1px solid #b8daff; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        
        .hidden { display: none !important; }
        
        .countdown {
            font-size: 14px;
            color: #666;
            margin-top: 10px;
        }
        
        .user-info {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: left;
        }
        
        .code-instruction {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            font-size: 14px;
        }
        
        .debug {
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            margin-top: 20px;
            font-family: monospace;
            font-size: 11px;
            text-align: left;
            max-height: 120px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo">ğŸ¨</div>
        <h1>IllustAuto</h1>
        <p class="subtitle">AIç”»åƒç”Ÿæˆã‚µãƒ¼ãƒ“ã‚¹ - ãƒ¡ãƒ¼ãƒ«èªè¨¼</p>
        
        <div id="status" class="status"></div>
        
        <!-- ãƒ¡ãƒ¼ãƒ«å…¥åŠ›ãƒ•ã‚§ãƒ¼ã‚º -->
        <div id="emailPhase">
            <div class="form-group">
                <label for="email">ğŸ“§ ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                <input type="email" id="email" placeholder="your@email.com" required>
            </div>
            <button id="sendCode">ğŸ”‘ èªè¨¼ã‚³ãƒ¼ãƒ‰ã‚’é€ä¿¡</button>
        </div>
        
        <!-- ã‚³ãƒ¼ãƒ‰å…¥åŠ›ãƒ•ã‚§ãƒ¼ã‚º -->
        <div id="codePhase" class="hidden">
            <div class="code-instruction" id="codeInstruction">
                <strong>ğŸ“‹ èªè¨¼ã‚³ãƒ¼ãƒ‰ã®ç¢ºèª:</strong><br>
                <span id="emailModeText">ãƒ¡ãƒ¼ãƒ«ãƒœãƒƒã‚¯ã‚¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„</span>
            </div>
            
            <div class="form-group">
                <label for="code">ğŸ”¢ èªè¨¼ã‚³ãƒ¼ãƒ‰ï¼ˆ6æ¡ï¼‰</label>
                <input type="text" id="code" class="code-input" placeholder="123456" maxlength="6" required>
                <div id="countdown" class="countdown"></div>
            </div>
            <button id="verifyCode">âœ… ãƒ­ã‚°ã‚¤ãƒ³</button>
            <button id="resendCode" class="secondary">ğŸ”„ ã‚³ãƒ¼ãƒ‰ã‚’å†é€ä¿¡</button>
            <button id="backToEmail" class="secondary">â† ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã«æˆ»ã‚‹</button>
        </div>
        
        <!-- æˆåŠŸãƒ•ã‚§ãƒ¼ã‚º -->
        <div id="successPhase" class="hidden">
            <h2>ğŸ‰ ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸï¼</h2>
            <div id="userInfo" class="user-info"></div>
            <button id="continueBtn">ğŸš€ IllustAutoã‚’ä½¿ç”¨</button>
            <button id="logoutBtn" class="secondary">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        </div>
        
        <!-- ãƒ‡ãƒãƒƒã‚°æƒ…å ±ï¼ˆæœ¬ç•ªã§ã¯éè¡¨ç¤ºï¼‰ -->
        <div class="debug" style="display: none;">
            <strong>ğŸ”§ æ¥ç¶šçŠ¶æ³:</strong>
            <div id="debugLog">åˆæœŸåŒ–ä¸­...</div>
        </div>
    </div>

    <script>
        // è¨­å®š
        const BACKEND = 'https://illustauto-backend-production.up.railway.app';
        
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let countdownInterval = null;
        let debugLogs = [];
        let currentEmail = '';
        
        // DOMè¦ç´ 
        const elements = {
            status: document.getElementById('status'),
            emailPhase: document.getElementById('emailPhase'),
            codePhase: document.getElementById('codePhase'),
            successPhase: document.getElementById('successPhase'),
            email: document.getElementById('email'),
            code: document.getElementById('code'),
            sendCode: document.getElementById('sendCode'),
            verifyCode: document.getElementById('verifyCode'),
            resendCode: document.getElementById('resendCode'),
            backToEmail: document.getElementById('backToEmail'),
            countdown: document.getElementById('countdown'),
            userInfo: document.getElementById('userInfo'),
            continueBtn: document.getElementById('continueBtn'),
            logoutBtn: document.getElementById('logoutBtn'),
            debugLog: document.getElementById('debugLog')
        };
        
        // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ï¼ˆæœ¬ç•ªã§ã¯æœ€å°é™ï¼‰
        function debug(message) {
            // æœ¬ç•ªç’°å¢ƒã§ã¯ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ­ã‚°ã®ã¿ã€UIè¡¨ç¤ºãªã—
            if (window.location.hostname === 'localhost' || window.location.hostname.includes('127.0.0.1')) {
                const timestamp = new Date().toLocaleTimeString();
                debugLogs.push(`[${timestamp}] ${message}`);
                if (elements.debugLog) {
                    elements.debugLog.innerHTML = debugLogs.slice(-5).join('<br>');
                }
            }
            console.log(message);
        }
        
        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º
        function showStatus(message, type = 'info') {
            elements.status.textContent = message;
            elements.status.className = `status ${type}`;
            elements.status.style.display = 'block';
            
            // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ã¯é–‹ç™ºç’°å¢ƒã®ã¿
            if (window.location.hostname === 'localhost' || window.location.hostname.includes('127.0.0.1')) {
                debug(`Status [${type}]: ${message}`);
            }
            
            if (type !== 'error') {
                setTimeout(() => {
                    elements.status.style.display = 'none';
                }, 5000);
            }
        }
        
        // ãƒ•ã‚§ãƒ¼ã‚ºåˆ‡ã‚Šæ›¿ãˆ
        function showPhase(phase) {
            elements.emailPhase.classList.toggle('hidden', phase !== 'email');
            elements.codePhase.classList.toggle('hidden', phase !== 'code');
            elements.successPhase.classList.toggle('hidden', phase !== 'success');
            // debug(`Phase: ${phase}`); // æœ¬ç•ªã§ã¯éè¡¨ç¤º
        }
        
        // ãƒ¡ãƒ¼ãƒ«æ¤œè¨¼
        function isValidEmail(email) {
            return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
        }
        
        // API ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
        function apiRequest(endpoint, options = {}) {
            return new Promise((resolve, reject) => {
                const xhr = new XMLHttpRequest();
                xhr.open(options.method || 'GET', BACKEND + endpoint);
                
                if (options.headers) {
                    Object.keys(options.headers).forEach(key => {
                        xhr.setRequestHeader(key, options.headers[key]);
                    });
                }
                
                xhr.onload = function() {
                    try {
                        const data = JSON.parse(xhr.responseText);
                        resolve({
                            ok: xhr.status >= 200 && xhr.status < 300,
                            status: xhr.status,
                            data
                        });
                    } catch (e) {
                        resolve({
                            ok: false,
                            status: xhr.status,
                            data: { error: 'Parse error', raw: xhr.responseText }
                        });
                    }
                };
                
                xhr.onerror = () => reject(new Error('Network error'));
                xhr.send(options.body || null);
            });
        }
        
        // èªè¨¼ã‚³ãƒ¼ãƒ‰é€ä¿¡
        async function sendAuthCode() {
            const email = elements.email.value.trim();
            
            if (!email) {
                showStatus('ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }
            
            if (!isValidEmail(email)) {
                showStatus('æœ‰åŠ¹ãªãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }
            
            elements.sendCode.disabled = true;
            elements.sendCode.textContent = 'é€ä¿¡ä¸­...';
            currentEmail = email;
            
            debug(`Sending auth code to: ${email}`);
            
            try {
                const result = await apiRequest('/api/auth/request-code', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email })
                });
                
                debug(`Send code result: ${result.status}`);
                
                if (result.ok && result.data.success) {
                    showStatus('èªè¨¼ã‚³ãƒ¼ãƒ‰ã‚’é€ä¿¡ã—ã¾ã—ãŸï¼Railwayãƒ­ã‚°ã§ç¢ºèªã—ã¦ãã ã•ã„', 'success');
                    showPhase('code');
                    startCountdown(300); // 5åˆ†
                    elements.code.focus();
                } else {
                    showStatus(result.data.message || 'ã‚³ãƒ¼ãƒ‰é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                }
            } catch (error) {
                debug(`Send code error: ${error.message}`);
                showStatus(`ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            } finally {
                elements.sendCode.disabled = false;
                elements.sendCode.textContent = 'ğŸ”‘ èªè¨¼ã‚³ãƒ¼ãƒ‰ã‚’é€ä¿¡';
            }
        }
        
        // èªè¨¼ã‚³ãƒ¼ãƒ‰æ¤œè¨¼
        async function verifyAuthCode() {
            const code = elements.code.value.trim();
            
            if (!code) {
                showStatus('èªè¨¼ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }
            
            if (!/^\d{6}$/.test(code)) {
                showStatus('èªè¨¼ã‚³ãƒ¼ãƒ‰ã¯6æ¡ã®æ•°å­—ã§å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }
            
            elements.verifyCode.disabled = true;
            elements.verifyCode.textContent = 'èªè¨¼ä¸­...';
            
            debug(`Verifying code: ${code}`);
            
            try {
                const result = await apiRequest('/api/auth/verify-code', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: currentEmail, code })
                });
                
                debug(`Verify result: ${result.status}`);
                
                if (result.ok && result.data.success) {
                    showStatus('ãƒ­ã‚°ã‚¤ãƒ³ã«æˆåŠŸã—ã¾ã—ãŸï¼', 'success');
                    
                    // ãƒˆãƒ¼ã‚¯ãƒ³ä¿å­˜
                    localStorage.setItem('illustauto_access_token', result.data.accessToken);
                    localStorage.setItem('illustauto_refresh_token', result.data.refreshToken);
                    localStorage.setItem('illustauto_user', JSON.stringify(result.data.user));
                    
                    // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±è¡¨ç¤ºï¼ˆéè¡¨ç¤ºï¼‰
                    elements.userInfo.innerHTML = ``;
                    
                    showPhase('success');
                    clearCountdown();
                } else {
                    showStatus(result.data.message || 'èªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                }
            } catch (error) {
                debug(`Verify error: ${error.message}`);
                showStatus(`ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            } finally {
                elements.verifyCode.disabled = false;
                elements.verifyCode.textContent = 'âœ… ãƒ­ã‚°ã‚¤ãƒ³';
            }
        }
        
        // ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³
        function startCountdown(seconds) {
            clearCountdown();
            
            const updateCountdown = () => {
                if (seconds <= 0) {
                    elements.countdown.textContent = 'âš ï¸ ã‚³ãƒ¼ãƒ‰ãŒæœŸé™åˆ‡ã‚Œã§ã™ã€‚å†é€ä¿¡ã—ã¦ãã ã•ã„ã€‚';
                    elements.countdown.style.color = '#dc3545';
                    clearCountdown();
                    return;
                }
                
                const minutes = Math.floor(seconds / 60);
                const remainingSeconds = seconds % 60;
                elements.countdown.textContent = `â° æœ‰åŠ¹æœŸé™: ${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
                elements.countdown.style.color = '#666';
                seconds--;
            };
            
            updateCountdown();
            countdownInterval = setInterval(updateCountdown, 1000);
        }
        
        function clearCountdown() {
            if (countdownInterval) {
                clearInterval(countdownInterval);
                countdownInterval = null;
            }
            elements.countdown.textContent = '';
        }
        
        // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³
        function backToEmail() {
            showPhase('email');
            elements.email.value = currentEmail;
            clearCountdown();
        }
        
        function logout() {
            localStorage.removeItem('illustauto_access_token');
            localStorage.removeItem('illustauto_refresh_token');
            localStorage.removeItem('illustauto_user');
            showPhase('email');
            elements.email.value = '';
            elements.code.value = '';
            currentEmail = '';
            showStatus('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ', 'info');
        }
        
        function continueToApp() {
            // ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«é·ç§»
            showStatus('IllustAutoã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’èµ·å‹•ä¸­...', 'info');
            setTimeout(() => {
                window.location.href = 'index.html';
            }, 500);
        }
        
        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        elements.sendCode.addEventListener('click', sendAuthCode);
        elements.verifyCode.addEventListener('click', verifyAuthCode);
        elements.resendCode.addEventListener('click', sendAuthCode);
        elements.backToEmail.addEventListener('click', backToEmail);
        elements.logoutBtn.addEventListener('click', logout);
        elements.continueBtn.addEventListener('click', continueToApp);
        
        // Enter ã‚­ãƒ¼å¯¾å¿œ
        elements.email.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendAuthCode();
        });
        
        elements.code.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') verifyAuthCode();
        });
        
        // æ•°å­—ã®ã¿å…¥åŠ›
        elements.code.addEventListener('input', (e) => {
            e.target.value = e.target.value.replace(/\D/g, '');
        });
        
        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', async () => {
            debug('ğŸš€ IllustAuto èªè¨¼ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–');
            debug(`Backend: ${BACKEND}`);
            
            // æ¥ç¶šãƒ†ã‚¹ãƒˆ
            try {
                const result = await apiRequest('/health');
                if (result.ok) {
                    debug(`âœ… Server connected: ${result.data.version}`);
                    showStatus('ã‚µãƒ¼ãƒãƒ¼æ¥ç¶šç¢ºèªæ¸ˆã¿', 'success');
                } else {
                    debug(`âŒ Server error: ${result.status}`);
                    showStatus('ã‚µãƒ¼ãƒãƒ¼æ¥ç¶šã‚¨ãƒ©ãƒ¼', 'error');
                }
            } catch (error) {
                debug(`âŒ Connection failed: ${error.message}`);
                showStatus('ã‚µãƒ¼ãƒãƒ¼æ¥ç¶šå¤±æ•—', 'error');
            }
            
            // æ—¢å­˜ãƒ­ã‚°ã‚¤ãƒ³ç¢ºèª
            const savedToken = localStorage.getItem('illustauto_access_token');
            const savedUser = localStorage.getItem('illustauto_user');
            
            if (savedToken && savedUser) {
                try {
                    const user = JSON.parse(savedUser);
                    elements.userInfo.innerHTML = ``;
                    showPhase('success');
                    showStatus('å‰å›ã®ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ã§å¾©å…ƒã—ã¾ã—ãŸ', 'info');
                    debug('Restored previous login');
                } catch (e) {
                    debug('Failed to restore login');
                    logout();
                }
            }
        });
    </script>
</body>
</html>
